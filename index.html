
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –ÆKassa
#BOT_TOKEN = '7284404713:AAG-5v7UNhuzvQ6_CzNSPCK-1n3Pc33Md2o'
#SHOP_ID = '448544'  # ID –≤–∞—à–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞
#SHOP_API_TOKEN = 'test_Wb2Tfgt1fCNqAtPH6_skmG02D9TqIOTgPwlZkLwEd4o'  # –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á API
#"return_url": "https://t.me/spokoinomasha_bot"

import json
import sqlite3
import datetime
import asyncio
import csv
import os
import random
import requests
from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import InputFile
from yookassa import Configuration, Payment
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from aiogram.utils import executor
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
#from datetime import datetime

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –ÆKassa
BOT_TOKEN = '7950510352:AAGu0Zq5Omakd4ZWIMwKzoyfvNg8i8J3ZQ4'
SHOP_ID = '448544'
SHOP_API_TOKEN = 'test_Wb2Tfgt1fCNqAtPH6_skmG02D9TqIOTgPwlZkLwEd4o'
RETURN_URL = 'https://t.me/Test_masha_test_bot'

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ÆKassa
Configuration.account_id = SHOP_ID
Configuration.secret_key = SHOP_API_TOKEN

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
conn = sqlite3.connect('subscriptions1.db')
cursor = conn.cursor()

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
cursor.execute('''
CREATE TABLE IF NOT EXISTS users (
    user_id INTEGER PRIMARY KEY,
    has_subscription BOOLEAN NOT NULL DEFAULT 0,
    subscription_end DATE,
    subscription_canceled BOOLEAN NOT NULL DEFAULT 0,
    purchase_date DATE DEFAULT NULL,
    renewal_count INTEGER DEFAULT 0,
    purchased_days INTEGER DEFAULT 0
)
''')

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–∂–∞–ª–∏ –Ω–∞ start
cursor.execute('''
    CREATE TABLE IF NOT EXISTS start_events (
        user_id INTEGER,
        event_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY (user_id)
    )
''')
conn.commit()

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ, –µ—Å–ª–∏ –æ–Ω–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
#–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ (purchase_date)
#–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–ª–µ–Ω–∏–π –ø–æ–¥–ø–∏—Å–∫–∏ (renewal_count)
#–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –¥–Ω–µ–π (purchased_days)
cursor.execute("PRAGMA table_info(users)")
columns = cursor.fetchall()
existing_columns = [column[1] for column in columns]
if 'purchase_date' not in existing_columns:
    cursor.execute('ALTER TABLE users ADD COLUMN purchase_date DATE DEFAULT NULL')
if 'renewal_count' not in existing_columns:
    cursor.execute('ALTER TABLE users ADD COLUMN renewal_count INTEGER DEFAULT 0')
if 'purchased_days' not in existing_columns:
    cursor.execute('ALTER TABLE users ADD COLUMN purchased_days INTEGER DEFAULT 0')
# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É subscription_canceled, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
if 'subscription_canceled' not in existing_columns:
    cursor.execute('ALTER TABLE users ADD COLUMN subscription_canceled BOOLEAN NOT NULL DEFAULT 0')
# –£—Å—Ç–∞–Ω–æ–≤–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ subscription_canceled –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
cursor.execute('UPDATE users SET subscription_canceled = 0 WHERE subscription_canceled IS NULL')
conn.commit()

# –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è
cursor.execute('''
    CREATE TABLE IF NOT EXISTS course_progress (
        user_id INTEGER PRIMARY KEY,
        stage INTEGER DEFAULT 0,
        sleep_difficulty TEXT DEFAULT NULL,
        sleep_improvement_attempts TEXT DEFAULT NULL,
        sleep_goal INTEGER DEFAULT NULL,
        wake_up_time TEXT DEFAULT NULL, 
        day1_completion_time TIMESTAMP DEFAULT NULL,
        day2_completion_time TIMESTAMP DEFAULT NULL,
        day3_completion_time TIMESTAMP DEFAULT NULL
    )
''')
conn.commit()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–¥—ä–µ–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def set_wake_up_time(user_id, wake_up_time):
    cursor.execute('''
        UPDATE course_progress SET wake_up_time = ?
        WHERE user_id = ?
    ''', (wake_up_time, user_id))
    conn.commit()

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
cursor.execute('''
    CREATE TABLE IF NOT EXISTS user_requests (
        user_id INTEGER,
        request_time TIMESTAMP,
        PRIMARY KEY (user_id, request_time)
    )
''')

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
cursor.execute('''
    CREATE TABLE IF NOT EXISTS sent_files (
        user_id INTEGER,
        file_name TEXT,
        level INTEGER DEFAULT 1,
        PRIMARY KEY (user_id, file_name)
    )
''')
conn.commit()

# –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
cursor.execute('''
    CREATE TABLE IF NOT EXISTS mood_log (
        user_id INTEGER,
        date DATE,
        mood TEXT
    )
''')
conn.commit()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤–æ–¥–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π
def get_mood_summary(user_id, days):
    """
    –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —á–∞—Å—Ç–æ—Ç—ã –≤—ã–±–æ—Ä–∞ –∫–∞–∂–¥–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
    - user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è —Å–≤–æ–¥–∫–∞.
    - days: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π, –∑–∞ –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –ø–æ—Å—á–∏—Ç–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    - —Å—Ç—Ä–æ–∫—É —Å –∫—Ä–∞—Å–∏–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º —Å–≤–æ–¥–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π.
    """
    # –ó–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–∞–∂–¥–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
    cursor.execute('''
        SELECT mood, COUNT(mood) as count FROM mood_logs
        WHERE user_id = ? AND request_time >= datetime('now', ? || ' days')
        GROUP BY mood
        ORDER BY count DESC
    ''', (user_id, -days))

    # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞
    results = cursor.fetchall()

    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if results:
        summary = f"–¢—Ä–µ–Ω–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {days} –¥–Ω–µ–π:\n\n"
        for mood, count in results:
            summary += f"{mood}: {count} —Ä–∞–∑(–∞)\n"
        return summary
    else:
        return "–ó–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è—Ö."

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
def create_payment(value, description):
    try:
        payment = Payment.create({
            "amount": {
                "value": value,
                "currency": "RUB"
            },
            "payment_method_data": {
                "type": "bank_card"
            },
            "confirmation": {
                "type": "redirect",
                "return_url": RETURN_URL
            },
            "capture": True,
            "description": description,
            "receipt": {
                "customer": {
                    "email": "gowaone1@gmail.com"  # –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω, –Ω–∞–ø—Ä–∏–º–µ—Ä "phone": "+79000000000"
                },
                "items": [
                    {
                        "description": description,
                        "quantity": "1.00",  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
                        "amount": {
                            "value": value,
                            "currency": "RUB"
                        },
                        "vat_code": "1",  # –ù–î–° 20%
                        "payment_mode": "full_payment",  # –†–µ–∂–∏–º –æ–ø–ª–∞—Ç—ã
                        "payment_subject": "service"  # –í–∏–¥ —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ —É—Å–ª—É–≥–∏
                    }
                ]
            }
        })
        return json.loads(payment.json())
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞: {str(e)}")
        return None

# –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞
async def check_payment(payment_id, max_attempts=20, delay=10):
    try:
        attempts = 0
        while attempts < max_attempts:
            attempts += 1
            payment = Payment.find_one(payment_id)
            payment_data = json.loads(payment.json())

            if payment_data['status'] == 'succeeded':
                return True
            elif payment_data['status'] == 'canceled':
                return False

            await asyncio.sleep(delay)

        return False
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–ª–∞—Ç–µ–∂–∞: {str(e)}")
        return False

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏
def update_subscription_status(user_id, status, days=7, cancel=False):
    end_date = None
    purchase_date = None
    renewal_count = 0  # –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    purchased_days = days  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –¥–Ω–µ–π

    if status:  # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
        end_date = (datetime.datetime.now() + datetime.timedelta(days=days)).date()
        purchase_date = datetime.datetime.now().date()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        cursor.execute('SELECT renewal_count, subscription_end FROM users WHERE user_id = ?', (user_id,))
        result = cursor.fetchone()

        if result:  # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            renewal_count = result[0] + 1  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–æ–¥–ª–µ–Ω–∏–π
            existing_end_date_str = result[1]
            if existing_end_date_str:
                existing_end_date = datetime.datetime.strptime(existing_end_date_str, '%Y-%m-%d').date()
                # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –∏–∑ –¥–≤—É—Ö –¥–∞—Ç
                new_end_date = max(existing_end_date, end_date)
            else:
                new_end_date = end_date

            cursor.execute('''
                UPDATE users 
                SET has_subscription = ?, 
                    subscription_end = ?, 
                    purchase_date = ?, 
                    renewal_count = ?, 
                    purchased_days = purchased_days + ? 
                WHERE user_id = ?
            ''', (status, new_end_date, purchase_date, renewal_count, days, user_id))
        else:  # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–æ–≤—ã–π
            cursor.execute('''
                INSERT INTO users (user_id, has_subscription, subscription_end, purchase_date, renewal_count, purchased_days)
                VALUES (?, ?, ?, ?, ?, ?)
            ''', (user_id, status, end_date, purchase_date, renewal_count, purchased_days))
    else:  # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞
        cursor.execute('''
            UPDATE users 
            SET subscription_canceled = 1 -- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏
            WHERE user_id = ?
        ''', (user_id,))

    conn.commit()

#–õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏:
def get_subscription_status(user_id):
    cursor.execute('SELECT has_subscription, subscription_end, subscription_canceled FROM users WHERE user_id = ?',
                   (user_id,))
    result = cursor.fetchone()
    if result:
        has_subscription, end_date_str, canceled = result
        end_date = None
        if end_date_str:
            end_date = datetime.datetime.strptime(end_date_str, '%Y-%m-%d').date()
        # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –∏ –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞
        if canceled and end_date and datetime.datetime.now().date() > end_date:
            return False, None
        if has_subscription and end_date and datetime.datetime.now().date() <= end_date:
            return True, end_date
    return False, None

def get_subscription_info(user_id):
    has_subscription, end_date = get_subscription_status(user_id)
    if has_subscription:
        days_remaining = (end_date - datetime.datetime.now().date()).days
        return f"–í–∞—à–∞ –ø—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–µ–Ω. –î–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –æ—Å—Ç–∞–ª–æ—Å—å {days_remaining} –¥–Ω–µ–π."
    else:
        return "–í–∞—à–∞ –ø—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω."

#–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–π
def renew_subscription(user_id, additional_days):
    cursor.execute('SELECT renewal_count, subscription_end FROM users WHERE user_id = ?', (user_id,))
    result = cursor.fetchone()

    if result:
        renewal_count, end_date_str = result
        new_renewal_count = renewal_count + 1
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤—É—é –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
        if end_date_str:
            new_end_date = datetime.datetime.strptime(end_date_str, '%Y-%m-%d').date() + datetime.timedelta(
                days=additional_days)
        else:
            new_end_date = (datetime.datetime.now() + datetime.timedelta(days=additional_days)).date()
        # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–¥–ø–∏—Å–∫–µ
        cursor.execute('''
            UPDATE users 
            SET subscription_end = ?, 
                renewal_count = ?, 
                purchased_days = purchased_days + ?
            WHERE user_id = ?
        ''', (new_end_date, new_renewal_count, additional_days, user_id))
        conn.commit()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
def check_request_limit(user_id):
    ten_hours_ago = datetime.datetime.now() - datetime.timedelta(hours=10)
    cursor.execute('''
        SELECT COUNT(*) FROM user_requests
        WHERE user_id = ? AND request_time > ?
    ''', (user_id, ten_hours_ago))
    count = cursor.fetchone()[0]
    return count < 3

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–∏—Å–∏ –∑–∞–ø—Ä–æ—Å–∞
def log_request(user_id):
    cursor.execute('''
        INSERT INTO user_requests (user_id, request_time)
        VALUES (?, ?)
    ''', (user_id, datetime.datetime.now()))
    conn.commit()

# ************************************ –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —É—Ä–æ–≤–Ω—è–º–∏ ***********************************************

# Function to get the user's level
def get_level(user_id):
    cursor.execute('SELECT MAX(level) FROM sent_files WHERE user_id = ?', (user_id,))
    result = cursor.fetchone()[0]
    return result if result else 1  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —É—Ä–æ–≤–µ–Ω—å 1

def listens_needed_for_next_level(level):
    return 2 ** level  # –ì–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è: 1, 2, 4, 8, ...

# Function to update user level
def log_sent_file(user_id, file_name):
    cursor.execute('SELECT COUNT(*) FROM sent_files WHERE user_id = ? AND file_name = ?', (user_id, file_name))
    exists = cursor.fetchone()[0]
    if not exists:
        cursor.execute('INSERT INTO sent_files (user_id, file_name, level) VALUES (?, ?, ?)', (user_id, file_name, 1))
        conn.commit()
        print(f"[DEBUG] –ù–æ–≤—ã–π —Ñ–∞–π–ª {file_name} –∑–∞–ø–∏—Å–∞–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        update_level(user_id)  # –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    else:
        print(f"[DEBUG] –§–∞–π–ª {file_name} —É–∂–µ –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")

def update_level(user_id):
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    cursor.execute('SELECT level, sent_files_count FROM users WHERE user_id = ?', (user_id,))
    result = cursor.fetchone()
    current_level = result[0] if result else 1  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —É—Ä–æ–≤–µ–Ω—å 1
    sent_files_count = result[1] if result else 0  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 0

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π –Ω—É–∂–Ω–æ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
    listens_needed = listens_needed_for_next_level(current_level)

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–ª—É—à–∞–ª –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ñ–∞–π–ª–æ–≤, –ø–æ–≤—ã—à–∞–µ–º —É—Ä–æ–≤–µ–Ω—å
    if sent_files_count >= listens_needed:
        new_level = current_level + 1
        cursor.execute('UPDATE users SET level = ? WHERE user_id = ?', (new_level, user_id))
        conn.commit()
        print(f"[DEBUG] –£—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ {new_level}")
    else:
        print(f"[DEBUG] –£—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –æ—Å—Ç–∞–µ—Ç—Å—è {current_level}")
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    cursor.execute('SELECT level, sent_files_count FROM users WHERE user_id = ?', (user_id,))
    result = cursor.fetchone()
    current_level = result[0] if result else 1  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —É—Ä–æ–≤–µ–Ω—å 1
    sent_files_count = result[1] if result else 0  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 0

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π –Ω—É–∂–Ω–æ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
    listens_needed = listens_needed_for_next_level(current_level)

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–ª—É—à–∞–ª –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ñ–∞–π–ª–æ–≤, –ø–æ–≤—ã—à–∞–µ–º —É—Ä–æ–≤–µ–Ω—å
    if sent_files_count >= listens_needed:
        new_level = current_level + 1
        cursor.execute('UPDATE users SET level = ? WHERE user_id = ?', (new_level, user_id))
        conn.commit()
        print(f"[DEBUG] –£—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ {new_level}")
    else:
        print(f"[DEBUG] –£—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –æ—Å—Ç–∞–µ—Ç—Å—è {current_level}")

# *********************************************** –ö–æ–Ω–µ—Ü –±–ª–æ–∫–∞ —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —É—Ä–æ–≤–Ω—è–º–∏ *************************

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
def get_sent_files(user_id):
    cursor.execute('SELECT file_name FROM sent_files WHERE user_id = ?', (user_id,))
    return [row[0] for row in cursor.fetchall()]

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–∏—Å–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
def log_sent_file(user_id, file_name):
    cursor.execute('SELECT COUNT(*) FROM sent_files WHERE user_id = ? AND file_name = ?', (user_id, file_name))
    exists = cursor.fetchone()[0]
    if not exists:
        # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        cursor.execute('INSERT INTO sent_files (user_id, file_name) VALUES (?, ?)', (user_id, file_name))
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        cursor.execute('''
            UPDATE users 
            SET sent_files_count = sent_files_count + 1 
            WHERE user_id = ?
        ''', (user_id,))
        conn.commit()
        print(f"[DEBUG] –ù–æ–≤—ã–π —Ñ–∞–π–ª {file_name} –∑–∞–ø–∏—Å–∞–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        update_level(user_id)  # –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    else:
        print(f"[DEBUG] –§–∞–π–ª {file_name} —É–∂–µ –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–ª—É—á–∞–π–Ω–æ–≥–æ MP3 —Ñ–∞–π–ª–∞, –∏—Å–∫–ª—é—á–∞—è —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ
def get_random_mp3_file(directory, user_id):
    all_files = [f for f in os.listdir(directory) if f.lower().endswith('.mp3')]
    if not all_files:
        return None  # –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None

    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    cursor.execute('SELECT file_name FROM sent_files WHERE user_id = ?', (user_id,))
    sent_files = [row[0] for row in cursor.fetchall()]

    # –ï—Å–ª–∏ –≤—Å–µ —Ñ–∞–π–ª—ã –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã, –æ—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    #if len(sent_files) == len(all_files):
    #    cursor.execute('DELETE FROM sent_files WHERE user_id = ?', (user_id,))
    #    conn.commit()
    #    sent_files = []  # –û—á–∏—Å—Ç–∏–ª–∏ –∏—Å—Ç–æ—Ä–∏—é, —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å —Ñ–∞–π–ª—ã —Å–Ω–æ–≤–∞

    # –ò—Å–∫–ª—é—á–∞–µ–º —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    available_files = [f for f in all_files if f not in sent_files]
    if not available_files:
        return None  # –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ —Å–Ω–æ–≤–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None

    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Ñ–∞–π–ª –∏–∑ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è
    selected_file = random.choice(available_files)
    file_path = os.path.join(directory, selected_file)
    log_sent_file(user_id, selected_file)  # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–∞–π–ª–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å
    return file_path

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
async def send_permanent_menu(message: types.Message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    markup.row("üåô–ë—ã—Å—Ç—Ä–µ–µ –∑–∞—Å–Ω—É—Ç—å", "üí§–û—Å–æ–±—ã–π —Ä–∞–∑–¥–µ–ª –¥–ª—è —Å–Ω–∞")
    markup.row("üë§–ü—Ä–æ—Ñ–∏–ª—å")
    await message.answer("–í—ã –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é, –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:", reply_markup=markup)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@dp.message_handler(commands=['start'])
async def start(message: types.Message):
    user_id = message.from_user.id
    try:
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü—É, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
        cursor.execute('''
            INSERT OR IGNORE INTO start_events (user_id) VALUES (?)
        ''', (user_id,))
        conn.commit()
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ —Å–æ–±—ã—Ç–∏—è /start: {e}")
    await message.answer("üôã‚Äç‚ôÄÔ∏è <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</b>\n"
                         "–Ø –ú–∞–Ω—è ‚Äî –≤–∞—à –ª–∏—á–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Ö–æ—Ä–æ—à–µ–≥–æ —Å–Ω–∞", parse_mode='HTML')
    await message.answer("<b>–°–æ–≤–µ—Ç—É—é –Ω–∞—á–∞—Ç—å —Å –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞</b>\n"
                         "üåô<u>–ë—ã—Å—Ç—Ä–µ–µ –∑–∞—Å–Ω—É—Ç—å</u> - –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥–æ–π–¥–µ—Ç –¥–ª—è –Ω–∞—à–µ–≥–æ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞! –Ø –ø—Ä–∏—à–ª—é –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Ä–∞—Å—Å–∫–∞–∑–æ–≤ –∏ –ø–æ–ª–µ–∑–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–µ–µ –∑–∞—Å–Ω—É—Ç—å.\n"
                         "üí§<u>–û—Å–æ–±—ã–π —Ä–∞–∑–¥–µ–ª –¥–ª—è —Å–Ω–∞</u> - –≤ —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –∫—É—Ä—Å, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∑–¥–æ—Ä–æ–≤—ã–π —Å–æ–Ω.\n–ê –µ—â–µ –º–Ω–æ–≥–æ –Ω–æ–≤—ã—Ö —Ä–∞—Å—Å–∫–∞–∑–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥–∞—é—Ç —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å–æ —Å—Ç—Ä–µ—Å—Å–æ–º, —Ç—Ä–µ–≤–æ–≥–∞–º–∏ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ–º –ø–µ—Ä–µ–¥ —Å–Ω–æ–º.\n\n"
                         "–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è! üíú", parse_mode='HTML')
    await send_permanent_menu(message)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
@dp.message_handler(lambda message: message.text == "üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
async def return_to_main_menu(message: types.Message):
    await send_permanent_menu(message)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ üí§–û—Å–æ–±—ã–π —Ä–∞–∑–¥–µ–ª –¥–ª—è —Å–Ω–∞
@dp.message_handler(lambda message: message.text == "üí§–û—Å–æ–±—ã–π —Ä–∞–∑–¥–µ–ª –¥–ª—è —Å–Ω–∞")
async def send_permanent_menu_for_sleep(message: types.Message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    markup.add("üéß–ü–æ—Å–ª—É—à–∞—Ç—å —Å–∫–∞–∑–∫–∏ –¥–ª—è —Å–Ω–∞", "üìö–ü—Ä–æ–π—Ç–∏ sleep –∫–æ–º–ø–ª–µ–∫—Å")
    markup.add("üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
    await message.answer("–í —ç—Ç–æ–º –æ—Å–æ–±–æ–º —Ä–∞–∑–¥–µ–ª–µ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å:\n\n"
                         "*üéß–°–∫–∞–∑–∫–∏ –¥–ª—è —Å–Ω–∞* - —è –ø—Ä–∏—à–ª—é —É–Ω–∏–∫–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ —Å–Ω–æ–º\n"
                         "*üìöSleep –∫–æ–º–ø–ª–µ–∫—Å* - –≤–º–µ—Å—Ç–µ —Å —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º, –î–∂–æ—Ä–¥–∂–µ–º, —è –ø—Ä–æ–≤–µ–¥—É –≤–∞—Å –∫ –ª—É—á—à–µ–º—É —Å–Ω—É –∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π", reply_markup=markup, parse_mode="Markdown")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "üåô–ë—ã—Å—Ç—Ä–µ–µ –∑–∞—Å–Ω—É—Ç—å"
@dp.message_handler(lambda message: message.text == "üåô–ë—ã—Å—Ç—Ä–µ–µ –∑–∞—Å–Ω—É—Ç—å")
async def free_stories(message: types.Message):
    # –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    text = (
        "üéß –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç–µ, –±–æ–ª–µ–µ *1 –º–∏–ª–ª–∏–æ–Ω–∞ —á–µ–ª–æ–≤–µ–∫* —Å–ª—É—à–∞—é—Ç —Ä–∞—Å—Å–∫–∞–∑—ã –ø–µ—Ä–µ–¥ —Å–Ω–æ–º.\n\n"
        "–ú–æ–∏ —Å–æ–∑–¥–∞—Ç–µ–ª–∏ –ø–æ—à–ª–∏ –¥–∞–ª—å—à–µ! –í–Ω–µ–¥—Ä–∏–ª–∏ –≤ —Ä–∞—Å—Å–∫–∞–∑—ã —ç–ª–µ–º–µ–Ω—Ç—ã –º–µ–¥–∏—Ç–∞—Ü–∏–∏: –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤–ø–ª–µ—Ç–µ–Ω—ã –≤ —Å—é–∂–µ—Ç.\n\n"
        "–¢–µ–ø–µ—Ä—å –≤—ã –¥—ã—à–∏—Ç–µ –≤–º–µ—Å—Ç–µ —Å –≥–µ—Ä–æ—è–º–∏, —Ä–∞—Å—Å–ª–∞–±–ª—è–µ—Ç–µ—Å—å –∏ –∑–∞—Å—ã–ø–∞–µ—Ç–µ –±—ã—Å—Ç—Ä–µ–µ. –ü–æ–¥—Ö–æ–¥–∏—Ç –∏ –≤–∑—Ä–æ—Å–ª—ã–º, –∏ –¥–µ—Ç—è–º.\n\n"
        "üëá –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—Å–∫–∞–∑, –≤–∫–ª—é—á–∏—Ç–µ –∞—É–¥–∏–æ –∏ –æ—Ç–¥—ã—Ö–∞–π—Ç–µ. –ö –∞—É–¥–∏–æ —è –ø—Ä–∏–ª–æ–∂—É –ø–æ–ª–µ–∑–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª –±–µ—Å–ø–ª–∞—Ç–Ω–æ."
    )
    # –°–æ–∑–¥–∞–µ–º inline-–∫–Ω–æ–ø–∫–∏
    markup = InlineKeyboardMarkup(row_width=1)
    markup.add(
        InlineKeyboardButton("–†–∞—Å—Å–∫–∞–∑ –î–∂–æ—Ä–¥–∂–∞ - –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –≤ –ª–∞–≥–µ—Ä—å", callback_data="story_1"),
        InlineKeyboardButton("–†–∞—Å—Å–∫–∞–∑ –ú–∏–ª—ã - –ú–∞–ª–µ–Ω—å–∫–∞—è –º–µ—á—Ç–∞", callback_data="story_2"),
        InlineKeyboardButton("–†–∞—Å—Å–∫–∞–∑ –î–∂–æ—Ä–¥–∂–∞ - –≠–ª–∏–∑–∞", callback_data="story_3")
    )
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
    await message.answer(text, parse_mode="Markdown", reply_markup=markup)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ inline-–∫–Ω–æ–ø–æ–∫
@dp.callback_query_handler(lambda callback: callback.data.startswith("story_"))
async def send_story(callback: types.CallbackQuery):
    user_id = callback.from_user.id
    story_id = callback.data
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —Ñ–∞–π–ª –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏ –∫–∞–∫—É—é –ø–æ–¥–ø–∏—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
    if story_id == "story_1":
        file_path = "free/–†–∞—Å—Å–∫–∞–∑ –î–∂–æ—Ä–¥–∂–∞ - –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –≤ –ª–∞–≥–µ—Ä—å.mp3"
        story_name = "‚òùÔ∏è–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ—Å–ª—É—à–∞—Ç—å —Ä–∞—Å—Å–∫–∞–∑ –Ω–∞ –Ω–æ—á—å –æ—Ç –î–∂–æ—Ä–¥–∂–∞ - –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –≤ –ª–∞–≥–µ—Ä—å"
        caption = (
            f"*{story_name}*\n\n"
            "–ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, —è –¥–æ–±–∞–≤–∏–ª–∞ —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç–∞—Ç—å—é –æ –ø–æ–ª—å–∑–µ —Å–∫–∞–∑–∫–æ—Ç–µ—Ä–∞–ø–∏–∏ –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö. –ß—Ç–µ–Ω–∏–µ –∑–∞–π–º–µ—Ç –≤—Å–µ–≥–æ –ø–∞—Ä—É –º–∏–Ω—É—Ç.\n"
            "–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –∏ —Å–ª–∞–¥–∫–∏—Ö —Å–Ω–æ–≤! üòä\n\n"
            "üìö[–ü—Ä–æ—á–∏—Ç–∞—Ç—å –æ –ø–æ–ª—å–∑–µ —Å–∫–∞–∑–∫–æ—Ç–µ—Ä–∞–ø–∏–∏](https://www.netoropis.ru/posts/Fairy-tale-therapy)\n\n"
            "–ê –µ—Å–ª–∏ –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å, –±–æ–ª—å—à–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∫–∞–∑–æ–∫ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ *–û—Å–æ–±–æ–º —Ä–∞–∑–¥–µ–ª–µ –¥–ª—è —Å–Ω–∞üí§*"
        )
    elif story_id == "story_2":
        file_path = "free/–†–∞—Å—Å–∫–∞–∑ –ú–∏–ª—ã - –ú–∞–ª–µ–Ω—å–∫–∞—è –º–µ—á—Ç–∞.mp3"
        story_name = "‚òùÔ∏è–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–ª—É—à–∞—Ç—å. –†–∞—Å—Å–∫–∞–∑ –Ω–∞ –Ω–æ—á—å –æ—Ç –ú–∏–ª—ã - –ú–∞–ª–µ–Ω—å–∫–∞—è –º–µ—á—Ç–∞"
        caption = (
            f"*{story_name}*\n\n"
            "–ö —ç—Ç–æ–º—É —Ä–∞—Å—Å–∫–∞–∑—É —è –¥–æ–±–∞–≤–∏–ª–∞ —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç–∞—Ç—å—é –æ —Ç–æ–º, –∫–∞–∫ –º—ã –æ—Ç–æ–¥–≤–∏–≥–∞–µ–º —Å–æ–Ω, –ø–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ—Å–≤—è—Ç–∏—Ç—å –≤—Ä–µ–º—è —Å–µ–±–µ. –ë—É–¥—É —Ä–∞–¥–∞, –∫–æ–≥–¥–∞ –ø–æ—á–∏—Ç–∞–µ—Ç–µ\n"
            "–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –∏ —Å–ª–∞–¥–∫–∏—Ö —Å–Ω–æ–≤! üòä\n\n"
            "üìö[–ü—Ä–æ—á–∏—Ç–∞—Ç—å –æ –ø—Ä–∏—á–∏–Ω–∞—Ö –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏–∏ –≤ —É—â–µ—Ä–± —Å–Ω—É](https://www.netoropis.ru/posts/Procrastination-at-the-expense-of-sleep)\n\n"
            "–ê –µ—Å–ª–∏ –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å, –±–æ–ª—å—à–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∫–∞–∑–æ–∫ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ *–û—Å–æ–±–æ–º —Ä–∞–∑–¥–µ–ª–µ –¥–ª—è —Å–Ω–∞üí§*"
        )
    elif story_id == "story_3":
        file_path = "free/–†–∞—Å—Å–∫–∞–∑ –î–∂–æ—Ä–¥–∂–∞ - –≠–ª–∏–∑–∞.mp3"
        story_name = "‚òùÔ∏è–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–ª—É—à–∞—Ç—å. –†–∞—Å—Å–∫–∞–∑ –Ω–∞ –Ω–æ—á—å –æ—Ç –î–∂–æ—Ä–¥–∂–∞ - –≠–ª–∏–∑–∞"
        caption = (
            f"*{story_name}*\n\n"
            "–ö —ç—Ç–æ–º—É —Ä–∞—Å—Å–∫–∞–∑—É —è –¥–æ–±–∞–≤–∏–ª–∞ —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç–∞—Ç—å—é –æ —Å–ø–æ—Ä—Ç–µ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º. –ü–æ–ª–µ–∑–Ω–æ –∏–ª–∏ –≤—Ä–µ–¥–Ω–æ? –ë—É–¥—É —Ä–∞–¥–∞, –∫–æ–≥–¥–∞ –ø–æ—á–∏—Ç–∞–µ—Ç–µ\n"
            "–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –∏ —Å–ª–∞–¥–∫–∏—Ö —Å–Ω–æ–≤! üòä\n\n"
            "üìö[–ü—Ä–æ—á–∏—Ç–∞—Ç—å –æ —Å–ø–æ—Ä—Ç–µ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º. –†–∞–∑–º–∏–Ω–∞–µ–º—Å—è](https://www.netoropis.ru/posts/Sports-before-bed)\n\n"
            "–ê –µ—Å–ª–∏ –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å, –±–æ–ª—å—à–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∫–∞–∑–æ–∫ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ *–û—Å–æ–±–æ–º —Ä–∞–∑–¥–µ–ª–µ –¥–ª—è —Å–Ω–∞üí§*"
        )

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ—Ñ–∞–π–ª —Å —Ç–µ–∫—Å—Ç–æ–º
    with open(file_path, "rb") as audio:
        await callback.message.answer_audio(
            audio,
            caption=caption,
            parse_mode="Markdown"
        )

    # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–∞–π–ª–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å
    filename = os.path.basename(file_path)  # –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ –ø—É—Ç–∏
    log_sent_file(user_id, filename)
    # –ó–∞–∫—Ä—ã–≤–∞–µ–º callback (—É–±–∏—Ä–∞–µ–º "—á–∞—Å–∏–∫–∏" –Ω–∞ –∫–Ω–æ–ø–∫–µ)
    await callback.answer()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –µ–µ –ø–æ–∫—É–ø–∫–∏
@dp.message_handler(lambda message: message.text in ["üéß–ü–æ—Å–ª—É—à–∞—Ç—å —Å–∫–∞–∑–∫–∏ –¥–ª—è —Å–Ω–∞", "üìö–ü—Ä–æ–π—Ç–∏ sleep –∫–æ–º–ø–ª–µ–∫—Å"])
async def handle_subscription(message: types.Message):
    status, _ = get_subscription_status(message.from_user.id)
    if not status:
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É "–ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø—Ä–æ –ø—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø"
        inline_markup = types.InlineKeyboardMarkup()
        inline_markup.add(
            types.InlineKeyboardButton(text="–ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø—Ä–æ –ø—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø", url="https://www.netoropis.ru/")
        )
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø–µ —Å –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π
        await message.answer(
            "<b>–°–ø–æ–∫–æ–π–Ω—ã–π —Å–æ–Ω ‚Äî –±–µ–∑ —É—Å–∏–ª–∏–π</b>\n"
            "–ü—Ä–µ–º–∏—É–º-–¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É –ú–∞–Ω–µ ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–∫–∞–∑–∫–∏, –∞ –≤–∞—à –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ª—ë–≥–∫–æ–≥–æ –∑–∞—Å—ã–ø–∞–Ω–∏—è, –≥–ª—É–±–æ–∫–æ–≥–æ —Å–Ω–∞ –∏ —Å–ø–æ–∫–æ–π–Ω–æ–≥–æ —É—Ç—Ä–∞\n\n"
            "üéØ <b>–ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ?</b>\n"
            "‚Ä¢ –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ—Å—å –∫ –ª—É—á—à–µ–º—É –æ—Ç–¥—ã—Ö—É –±–ª–∞–≥–æ–¥–∞—Ä—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏—Å—Ç–æ—Ä–∏—è–º —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º –º–µ–¥–∏—Ç–∞—Ü–∏–∏, –æ–∑–≤—É—á–µ–Ω–Ω—ã–º –∏–∑–≤–µ—Å—Ç–Ω—ã–º–∏ –≥–æ–ª–æ—Å–∞–º–∏\n"
            "‚Ä¢ –ü—Ä–æ—Å–ª–µ–¥–∏—Ç–µ –∑–∞ –≤–∞—à–∏–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º, –∫–∞–∂–¥—ã–π –≤–µ—á–µ—Ä, –ø–µ—Ä–µ–¥ —Å–Ω–æ–º\n"
            "‚Ä¢ –ê –µ—â–µ - —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –æ–∑–≤—É—á–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–π –ø–æ –∑–∞–ø—Ä–æ—Å—É, –ø—Ä–µ–≤—Ä–∞—â–∞—è –≤–∞—à–∏ –º–µ—á—Ç—ã –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å!", parse_mode='HTML')
        await message.answer(
            "<b>üåü –¢–∞—Ä–∏—Ñ—ã –Ω–∞ –≤—ã–±–æ—Ä:</b>\n"
            "‚Ä¢ –ù–∞ 30 –¥–Ω–µ–π - 450 —Ä—É–±–ª–µ–π\n"
            "‚Ä¢ –ù–∞ 365 –¥–Ω–µ–π + 30 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ üéÅ - 3600 —Ä—É–±–ª–µ–π\n"
            "<u>–≠–∫–æ–Ω–æ–º–∏—è 39%! –≠—Ç–æ –≤—Å–µ–≥–æ 276 —Ä—É–±–ª–µ–π –≤ –º–µ—Å—è—Ü!</u> "
            "–î–µ—à–µ–≤–ª–µ –∫–∞–ø—É—á–∏–Ω–∫–∏", parse_mode='HTML', reply_markup=inline_markup)
        # –ö–Ω–æ–ø–∫–∏ —Å –≤—ã–±–æ—Ä–æ–º —Ç–∏–ø–∞ –ø–æ–¥–ø–∏—Å–∫–∏, –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –≤ 2 —Å—Ç–æ–ª–±–∏–∫–∞ –∏ 2 —Å—Ç—Ä–æ–∫–∏
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
        markup.row("–û—Ñ–æ—Ä–º–∏—Ç—å –¥–æ—Å—Ç—É–ø –Ω–∞ 30 –¥–Ω–µ–π", "–û—Ñ–æ—Ä–º–∏—Ç—å –¥–æ—Å—Ç—É–ø –Ω–∞ 365+30 –¥–Ω–µ–π")
        markup.row("üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
        await message.answer(
            "–≠—Ç–æ —Ä–∞–∑–æ–≤—ã–π –¥–æ—Å—Ç—É–ø, –∞ –Ω–µ –ø–æ–¥–ø–∏—Å–∫–∞. –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ —É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –¥–µ–Ω—å–≥–∏ –Ω–µ —Å–ø–∏—à—É—Ç—Å—è –≤ –∫—Ä–∞–π–Ω–∏–π –¥–µ–Ω—å.",
            reply_markup=markup)
    else:
        # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ
        if message.text == "üìö–ü—Ä–æ–π—Ç–∏ sleep –∫–æ–º–ø–ª–µ–∫—Å":
            await start_sleep_course(message)
        elif message.text == "üéß–ü–æ—Å–ª—É—à–∞—Ç—å —Å–∫–∞–∑–∫–∏ –¥–ª—è —Å–Ω–∞":
            await send_sleep_stories(message)

#–ò—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–Ω–∞ #–ò—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–Ω–∞ #–ò—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–Ω–∞ #–ò—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–Ω–∞ #–ò—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–Ω–∞ #–ò—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–Ω–∞ #–ò—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–Ω–∞
@dp.message_handler(lambda message: message.text == "üéß–ü–æ—Å–ª—É—à–∞—Ç—å —Å–∫–∞–∑–∫–∏ –¥–ª—è —Å–Ω–∞")
async def send_sleep_stories(message: types.Message):
    status, _ = get_subscription_status(message.from_user.id)
    if not status:
        await handle_subscription(message)
    else:
        # –°—Ü–µ–Ω–∞—Ä–∏–π –≤—ã–±–æ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
        markup.add("üí≠–ú–Ω–æ–≥–æ –º—ã—Å–ª–µ–π", "üåµ–°—Ç—Ä–µ—Å—Å", "üïØÔ∏è–ü–µ—Ä–µ–∂–∏–≤–∞—é")
        markup.add("üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
        await message.answer("üíÅ‚Äç‚ôÄÔ∏è–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ —è –ø—Ä–∏—à–ª—é —Å–∫–∞–∑–∫—É:", reply_markup=markup)

@dp.message_handler(lambda message: message.text in ["üí≠–ú–Ω–æ–≥–æ –º—ã—Å–ª–µ–π", "üåµ–°—Ç—Ä–µ—Å—Å", "üïØÔ∏è–ü–µ—Ä–µ–∂–∏–≤–∞—é", "üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"])
async def send_material_based_on_mood(message: types.Message):
    if message.text == "üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
        return

    # –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∏—Å—Ç–æ—Ä–∏–∏
    mood = message.text
    user_id = message.from_user.id
    date = datetime.datetime.now().date()
    cursor.execute('INSERT INTO mood_log (user_id, date, mood) VALUES (?, ?, ?)', (user_id, date, mood))
    conn.commit()

    directory = os.path.join(os.getcwd(), 'stories')  # –£–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ 'stories' –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    file_path = get_random_mp3_file(directory, user_id)
    if file_path:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
        markup.add("üí≠–ú–Ω–æ–≥–æ –º—ã—Å–ª–µ–π", "üåµ–°—Ç—Ä–µ—Å—Å", "üïØÔ∏è–ü–µ—Ä–µ–∂–∏–≤–∞—é")
        markup.add("üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")  # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"

        # –ü–æ–ª—É—á–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        image_path = get_random_image_file('sleep_images')  # –ü–∞–ø–∫–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
        file_name_without_extension = os.path.splitext(os.path.basename(file_path))[0]  # –ò–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        caption_text = (
            "üíÅ‚Äç‚ôÄÔ∏è–†–∞—Å—Å–∫–∞–∑—ã –ø–µ—Ä–µ–¥ —Å–Ω–æ–º ‚Äî —ç—Ç–æ –æ—Ç–¥—ã—Ö –∏ —Å–Ω–∏–∂–µ–Ω–∏–µ —Å—Ç—Ä–µ—Å—Å–∞\n\n"
            f"–ù–∞–∑–≤–∞–Ω–∏–µ: *{file_name_without_extension}*.\n–ù–µ –∑–∞–±—É–¥—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å –ø–µ—Ä–µ–¥ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ–º!"
        )

        if image_path:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–æ–π
            with open(image_path, 'rb') as image_file:
                await message.answer_photo(
                    photo=image_file,
                    caption=caption_text,
                    parse_mode='Markdown',
                    reply_markup=markup
                )
        else:
            # –ï—Å–ª–∏ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
            await message.answer(caption_text, parse_mode='Markdown', reply_markup=markup)

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º MP3 —Ñ–∞–π–ª
        await message.answer_audio(audio=types.InputFile(file_path))
        log_sent_file(user_id, os.path.basename(file_path))  # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–∞–π–ª–∞
        log_request(user_id)
    else:
        await message.answer("–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–æ –≤ –ø–∞–ø–∫–µ –Ω–µ—Ç MP3 —Ñ–∞–π–ª–æ–≤.")

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
def get_random_image_file(directory):
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏."""
    all_images = [f for f in os.listdir(directory) if f.lower().endswith(('.png', '.jpg', '.jpeg'))]
    if all_images:
        return os.path.join(directory, random.choice(all_images))
    return None

#–ò—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–Ω–∞ #–ò—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–Ω–∞ #–ò—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–Ω–∞ #–ò—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–Ω–∞ #–ò—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–Ω–∞ #–ò—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–Ω–∞ #–ò—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–Ω–∞



##############################################################################################################

#–¢–µ–ø–µ—Ä—å update_course_stage –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è:
def update_course_stage(user_id, stage, completed=False, day=None, sleep_difficulty=None, sleep_improvement_attempts=None):
    completion_time = datetime.datetime.now() if completed else None
    try:
        if sleep_difficulty:
            cursor.execute('UPDATE course_progress SET stage = ?, sleep_difficulty = ? WHERE user_id = ?', (stage, sleep_difficulty, user_id))
        elif sleep_improvement_attempts:
            cursor.execute('UPDATE course_progress SET stage = ?, sleep_improvement_attempts = ? WHERE user_id = ?', (stage, sleep_improvement_attempts, user_id))
        elif day == 1:
            cursor.execute('UPDATE course_progress SET stage = ?, day1_completion_time = ? WHERE user_id = ?', (stage, completion_time, user_id))
        elif day == 2:
            cursor.execute('UPDATE course_progress SET stage = ?, day2_completion_time = ? WHERE user_id = ?', (stage, completion_time, user_id))
        elif day == 3:
            cursor.execute('UPDATE course_progress SET stage = ?, day3_completion_time = ? WHERE user_id = ?', (stage, completion_time, user_id))
        else:
            cursor.execute('UPDATE course_progress SET stage = ? WHERE user_id = ?', (stage, user_id))
        conn.commit()
        print(f"[DEBUG] –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: —ç—Ç–∞–ø {stage}, –¥–µ–Ω—å {day}, –∑–∞–≤–µ—Ä—à–µ–Ω–æ={completed}")
        # –î–æ–±–∞–≤—å—Ç–µ –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        cursor.execute('SELECT * FROM course_progress WHERE user_id = ?', (user_id,))
        result = cursor.fetchone()
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: {str(e)}")

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞ –∫—É—Ä—Å–∞
def get_course_stage(user_id):
    cursor.execute('SELECT stage FROM course_progress WHERE user_id = ?', (user_id,))
    result = cursor.fetchone()
    if result:
        return result[0]  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏–µ stage –∫–∞–∫ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
    else:
        cursor.execute('INSERT INTO course_progress (user_id, stage) VALUES (?, ?)', (user_id, 0))
        conn.commit()
        return 0  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º 0 –∫–∞–∫ –Ω–∞—á–∞–ª—å–Ω—ã–π —ç—Ç–∞–ø

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–Ω—é
def can_access_next_day(user_id, day, force_next_day=False):
    if force_next_day:
        return True  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Ä–µ–º–µ–Ω–∏, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–ù–∞—á–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –∫–æ–º–ø–ª–µ–∫—Å–∞"
    # –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ (–∫–∞–∫ –≤ –≤–∞—à–µ–º –∫–æ–¥–µ)
    column = {
        "day1": "day1_completion_time",
        "day2": "day2_completion_time",
        "day3": "day3_completion_time"
    }.get(day)
    if not column:
        print(f"[DEBUG] Invalid day argument: {day}")
        return False
    cursor.execute(f'SELECT {column} FROM course_progress WHERE user_id = ?', (user_id,))
    result = cursor.fetchone()
    if result and result[0]:
        last_completion_time = datetime.datetime.strptime(result[0], "%Y-%m-%d %H:%M:%S.%f")
        time_since_completion = (datetime.datetime.now() - last_completion_time).total_seconds()
        can_access = time_since_completion >= 12 * 60 * 60  # 12 —á–∞—Å–æ–≤
        print(f"[DEBUG] Time since last completion: {time_since_completion} seconds. Can access next day: {can_access}")
        return can_access
    print("[DEBUG] No completion time found, cannot access next day yet.")
    return False

# –≠—Ç–∞–ø 0: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∫–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å"
async def stage_0_welcome(message: types.Message):
    await message.answer("üíÅ‚Äç‚ôÄÔ∏è –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ 3-—Ö –¥–Ω–µ–≤–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å –¥–ª—è —Å–Ω–∞!")
    await message.answer("–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º.\n\n–í —ç—Ç–æ–º –∫–æ–º–ø–ª–µ–∫—Å–µ, –∑–∞ 3 –≤–µ—á–µ—Ä–∞ –º–æ–π —Å–æ–∑–¥–∞—Ç–µ–ª—å –î–∂–æ—Ä–¥–∂ —Ä–∞—Å—Å–∫–∞–∂–µ—Ç –≤–∞–º:\n"
                         "‚Ä¢ –ß—Ç–æ —Ç–∞–∫–æ–µ —Å–æ–Ω –∏ –∫–∞–∫ –µ–≥–æ —É–ª—É—á—à–∏—Ç—å,\n"
                         "‚Ä¢ –†–∞—Å—Å–∫–∞–∂–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Å–Ω–∞ —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –º–µ–¥–∏—Ç–∞—Ü–∏–∏.")
    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —ç—Ç–∞–ø—É 1
    markup = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    markup.add("–ù–∞—á–∞—Ç—å")
    await message.answer("–ö–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã, –Ω–∞–∂–º–∏—Ç–µ '–ù–∞—á–∞—Ç—å' –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è", reply_markup=markup)
    update_course_stage(message.from_user.id, 1)

# –≠—Ç–∞–ø 1: –û–ø—Ä–æ—Å –æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–Ω–∞
async def stage_1_sleep_duration(message: types.Message):
    markup = ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("–¢—Ä—É–¥–Ω–æ—Å—Ç–∏ —Å –∑–∞—Å—ã–ø–∞–Ω–∏–µ–º", "–ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è")
    markup.add("–†–∞–Ω–Ω–∏–µ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è", "–ù–µ—Ç —á—É–≤—Å—Ç–≤–∞ –æ—Ç–¥—ã—Ö–∞ –ø–æ—Å–ª–µ —Å–Ω–∞")
    await message.answer("üíÅ‚Äç‚ôÄÔ∏è –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º—Å—è, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –º–µ—à–∞–µ—Ç –≤–∞—à–µ–º—É —Å–Ω—É.\n\n<b>–ö–∞–∫–∞—è —Å–∞–º–∞—è –±–æ–ª—å—à–∞—è —Ç—Ä—É–¥–Ω–æ—Å—Ç—å —Å–æ —Å–Ω–æ–º –±–µ—Å–ø–æ–∫–æ–∏—Ç –≤–∞—Å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?</b>", parse_mode='HTML', reply_markup=markup)
    update_course_stage(message.from_user.id, 2)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ —Ç—Ä—É–¥–Ω–æ—Å—Ç—è—Ö —Å–æ —Å–Ω–æ–º
@dp.message_handler(lambda message: message.text in ["–¢—Ä—É–¥–Ω–æ—Å—Ç–∏ —Å –∑–∞—Å—ã–ø–∞–Ω–∏–µ–º", "–ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è", "–†–∞–Ω–Ω–∏–µ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è", "–ù–µ—Ç —á—É–≤—Å—Ç–≤–∞ –æ—Ç–¥—ã—Ö–∞ –ø–æ—Å–ª–µ —Å–Ω–∞"])
async def handle_sleep_difficulties(message: types.Message):
    user_id = message.from_user.id
    difficulty = message.text
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    cursor.execute('UPDATE course_progress SET sleep_difficulty = ? WHERE user_id = ?', (difficulty, user_id))
    conn.commit()
    await stage_2_set_sleep_goal(message)

# –≠—Ç–∞–ø 2: –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ –ø–æ–ø—ã—Ç–∫–∞—Ö —É–ª—É—á—à–∏—Ç—å —Å–æ–Ω
async def stage_2_set_sleep_goal(message: types.Message):
    markup = ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("–ú–µ–¥–∏—Ç–∞—Ü–∏—è", "–¢–µ–ø–ª–∞—è –≤–∞–Ω–Ω–∞", "–ß—Ç–µ–Ω–∏–µ", "–ù–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–±–æ–≤–∞–ª")
    await message.answer("üíÅ‚Äç‚ôÄÔ∏è –ü–æ–Ω—è–ª–∞, —Å–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–≤–µ—Ç!\n\n<b>–ß—Ç–æ –≤—ã —É–∂–µ –ø—Ä–æ–±–æ–≤–∞–ª–∏, —á—Ç–æ–±—ã —É–ª—É—á—à–∏—Ç—å —Å–æ–Ω, –∏ –ø–æ—á–µ–º—É —ç—Ç–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ?</b>", parse_mode='HTML', reply_markup=markup)
    update_course_stage(message.from_user.id, 3)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ –ø–æ–ø—ã—Ç–∫–∞—Ö —É–ª—É—á—à–∏—Ç—å —Å–æ–Ω
@dp.message_handler(lambda message: message.text in ["–ú–µ–¥–∏—Ç–∞—Ü–∏—è", "–¢–µ–ø–ª–∞—è –≤–∞–Ω–Ω–∞", "–ß—Ç–µ–Ω–∏–µ", "–ù–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–±–æ–≤–∞–ª"])
async def handle_sleep_attempts(message: types.Message):
    user_id = message.from_user.id
    attempt = message.text
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    cursor.execute('UPDATE course_progress SET sleep_improvement_attempts = ? WHERE user_id = ?', (attempt, user_id))
    conn.commit()
    await stage_3_relaxation(message)

# –≠—Ç–∞–ø 3: –¢–µ—Ö–Ω–∏–∫–∞ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏—è
async def stage_3_relaxation(message: types.Message):
    await message.answer("<b>–í –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –º—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º:</b>\n"
                         "‚Ä¢ –ß—Ç–æ —Ç–∞–∫–æ–µ —Å–æ–Ω?\n"
                         "‚Ä¢ –ü–æ—á–µ–º—É –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–æ–Ω —Ç–∞–∫ –≤–∞–∂–µ–Ω?\n"
                         "‚Ä¢ –°–∫–∞–∑–∫–∏ –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö —Ç–æ–∂–µ –ø–æ–ª–µ–∑–Ω—ã?", parse_mode='HTML')
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
    markup = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    markup.add("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å")
    await message.answer("–ß—Ç–æ–±—ã –∫–æ–º–ø–ª–µ–∫—Å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ–º–æ–≥, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–π–º–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏ –ø—Ä–∏–≥–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫–æ —Å–Ω—É.\n\n"
                         "–ö–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å', —è –ø—Ä–∏—à–ª—é –ø–µ—Ä–≤–æ–µ –∞—É–¥–∏–æ", reply_markup=markup)

# –≠—Ç–∞–ø 4: –û—Ç–ø—Ä–∞–≤–∫–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π –¥–ª—è —Å–Ω–∞
async def stage_4_story(message: types.Message):
    user_id = message.from_user.id
    # –£–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    file_path = "sleep_complex/–ü–µ—Ä–≤—ã–∏ÃÜ –¥–µ–Ω—å –∫–æ–º–ø–ª–µ–∫—Å–∞.mp3"
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª
    if os.path.exists(file_path):
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ—Ñ–∞–π–ª
        await message.answer_audio(audio=InputFile(file_path))
    else:
        await message.answer("–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
    # –°–æ–∑–¥–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É —Å–æ —Å—Å—ã–ª–∫–æ–π
    inline_markup = InlineKeyboardMarkup()
    inline_markup.add(
        InlineKeyboardButton(text="–ü—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç 1 –¥–Ω—è", url="https://www.netoropis.ru/posts/1DayMasha")
    )
    await message.answer(
        "üíÅ‚Äç‚ôÄÔ∏è –ü—Ä–∏—Å–ª–∞–ª–∞ –∞—É–¥–∏–æ —Ñ–∞–π–ª –≤—ã—à–µ.\n–û–∑–≤—É—á–∏–≤–∞–µ—Ç –æ–¥–∏–Ω –∏–∑ –º–æ–∏—Ö —Å–æ–∑–¥–∞—Ç–µ–ª–µ–π ‚Äî –î–∂–æ—Ä–¥–∂.\n\n"
        "–†–µ–∫–æ–º–µ–Ω–¥—É—é –∑–∞–Ω—è—Ç—å —É–¥–æ–±–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏ –ø–æ—Å–ª—É—à–∞—Ç—å, —á—Ç–æ–±—ã –±—ã–ª–æ –ø–æ–ª–Ω–æ–µ –ø–æ–≥—Ä—É–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º. –ù–æ –µ—Å–ª–∏ –Ω–µ—É–¥–æ–±–Ω–æ —Å–ª—É—à–∞—Ç—å ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–æ—á–∫—É –ø–æ–¥ —ç—Ç–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º:",
        reply_markup=inline_markup
    )
    # –ó–∞–≤–µ—Ä—à–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–µ—Ä–µ—Ö–æ–¥–æ–º –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏ –∫–Ω–æ–ø–∫–æ–π "–ù–∞—á–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –∫–æ–º–ø–ª–µ–∫—Å–∞"
    markup = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    markup.add("üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "–ù–∞—á–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –∫–æ–º–ø–ª–µ–∫—Å–∞")
    await message.answer(
        "–ü–æ—Å–ª—É—à–∞—Ç—å –¥—Ä—É–≥–∏–µ —Å–∫–∞–∑–∫–∏ –º–æ–∂–Ω–æ –≤ —Ä–∞–∑–¥–µ–ª–µ 'üí§–û—Å–æ–±—ã–π —Ä–∞–∑–¥–µ–ª –¥–ª—è —Å–Ω–∞' —á–µ—Ä–µ–∑ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é üòâ\n\n"
        "–ê –ø–æ–∫–∞ –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –∑–∞–≤–µ—Ä—à–µ–Ω! –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞–≤—Ç—Ä–∞ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º, —Ä–∞—Å—Å–∫–∞–∂—É –Ω–æ–≤—É—é —Å–∫–∞–∑–∫—É!\n\n"
        "–î–æ–±—Ä–æ–π –Ω–æ—á–∏ –∏ –ø—Ä–∏—è—Ç–Ω—ã—Ö —Å–Ω–æ–≤!\n-–ú–∞–Ω—è",
        reply_markup=markup
    )
    # –û–±–Ω–æ–≤–ª—è–µ–º —ç—Ç–∞–ø –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –∫—É—Ä—Å–∞
    update_course_stage(user_id, 5, completed=True, day=1)

# –≠—Ç–∞–ø 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
async def stage_5_check_next_day(message: types.Message):
    if can_access_next_day(message.from_user.id, "day1"):
        await stage_6_wake_up_time(message)
    else:
        await message.answer("–î–µ–Ω—å 2 –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ 12 —á–∞—Å–æ–≤. –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –ø–æ–∑–∂–µ!")

# –≠—Ç–∞–ø 6: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –≤—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–¥—ä–µ–º–∞
async def stage_6_wake_up_time(message: types.Message):
    user_id = message.from_user.id
    # –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ —Ç—Ä—É–¥–Ω–æ—Å—Ç—è—Ö –∏ –ø–æ–ø—ã—Ç–∫–∞—Ö
    cursor.execute('SELECT sleep_difficulty, sleep_improvement_attempts FROM course_progress WHERE user_id = ?', (user_id,))
    result = cursor.fetchone()
    sleep_difficulty, sleep_attempt = result if result else (None, None)

    await message.answer(
        f"üíÅ‚Äç‚ôÄÔ∏è –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º! –ù–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤:\n"
        f"‚Ä¢ –¢—Ä—É–¥–Ω–æ—Å—Ç—å: {sleep_difficulty}\n"
        f"‚Ä¢ –ü–æ–ø—ã—Ç–∫–∞ —É–ª—É—á—à–∏—Ç—å —Å–æ–Ω: {sleep_attempt}\n\n"
        "–°–µ–≥–æ–¥–Ω—è –º—ã –±—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–¥ —É–ª—É—á—à–µ–Ω–∏–µ–º –≤–∞—à–µ–≥–æ —Å–Ω–∞. –î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º —Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç—Ö–æ–¥–∞ –∫–æ —Å–Ω—É."
    )
    markup = ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("5:00", "6:00", "7:00", "8:00", "9:00", "10:00 –∏ –ø–æ–∑–∂–µ")
    await message.answer("–í–æ —Å–∫–æ–ª—å–∫–æ –≤–∞–º –∑–∞–≤—Ç—Ä–∞ –Ω—É–∂–Ω–æ –ø—Ä–æ—Å–Ω—É—Ç—å—Å—è?", reply_markup=markup)
    update_course_stage(message.from_user.id, 7)

# –≠—Ç–∞–ø 7: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —Å–Ω–∞
async def stage_7_set_bedtime(message: types.Message):
    wake_up_time = message.text
    set_wake_up_time(message.from_user.id, wake_up_time)

    # –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è —Å–Ω–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 8 —á–∞—Å–æ–≤)
    bed_time_hour = int(wake_up_time.split(":")[0]) - 8
    if bed_time_hour < 0:
        bed_time_hour += 24
    bed_time = f"{bed_time_hour}:00"

    markup = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    markup.add("–î–∞–≤–∞–π –ø—Ä–æ–¥–æ–ª–∂–∏–º")
    await message.answer(
        f"–û—Ç–ª–∏—á–Ω–æ! –ó–∞–≤—Ç—Ä–∞ –≤–∞–º –Ω—É–∂–Ω–æ –ø—Ä–æ—Å–Ω—É—Ç—å—Å—è –≤ {wake_up_time}. "
        f"–†–µ–∫–æ–º–µ–Ω–¥—É—é –ª–µ—á—å —Å–ø–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è –≤ {bed_time}. –í –∫—Ä–æ–≤–∞—Ç—å –ª—É—á—à–µ –ª–µ—á—å –∑–∞ 30-60 –º–∏–Ω—É—Ç –¥–æ —Å–Ω–∞."
    )
    await message.answer("<b>–í–æ –≤—Ç–æ—Ä–æ–π –¥–µ–Ω—å –º—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º:</b>\n"
                         "‚Ä¢ –ö–∞–∫ —Å–≤–µ—Ç –≤–ª–∏—è–µ—Ç –Ω–∞ –º–µ–ª–∞—Ç–æ–Ω–∏–Ω –∏ —Å–µ—Ä–æ—Ç–æ–Ω–∏–Ω?\n"
                         "‚Ä¢ –†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å —Å–Ω–∞: –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —á–∞—Å—ã?\n"
                         "‚Ä¢ –ü–æ—Å–ª—É—à–∞–µ–º —Å–∫–∞–∑–∫—É –¥–ª—è —Å–Ω–∞", parse_mode='HTML')
    await message.answer("–ö–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É '–î–∞–≤–∞–π –ø—Ä–æ–¥–æ–ª–∂–∏–º'", reply_markup=markup)
    update_course_stage(message.from_user.id, 8)

# –≠—Ç–∞–ø 8: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –¥–Ω—è
async def stage_8_day2_end(message: types.Message):
    user_id = message.from_user.id
    # –£–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    file_path = "sleep_complex/–í—Ç–æ—Ä–æ–∏ÃÜ –¥–µ–Ω—å –∫–æ–º–ø–ª–µ–∫—Å–∞.mp3"
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª
    if os.path.exists(file_path):
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ—Ñ–∞–π–ª
        await message.answer_audio(audio=InputFile(file_path))
    else:
        await message.answer("–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
    # –°–æ–∑–¥–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É —Å–æ —Å—Å—ã–ª–∫–æ–π
    inline_markup = InlineKeyboardMarkup()
    inline_markup.add(
        InlineKeyboardButton(text="–ü—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç 2 –¥–Ω—è", url="https://www.netoropis.ru/posts/2DayMasha")
    )
    await message.answer(
        "üíÅ‚Äç‚ôÄÔ∏è –ü—Ä–∏—Å–ª–∞–ª–∞ –∞—É–¥–∏–æ —Ñ–∞–π–ª –≤—ã—à–µ.\n–û–∑–≤—É—á–∏–≤–∞–µ—Ç –æ–¥–∏–Ω –∏–∑ –º–æ–∏—Ö —Å–æ–∑–¥–∞—Ç–µ–ª–µ–π ‚Äî –î–∂–æ—Ä–¥–∂.\n\n"
        "–†–µ–∫–æ–º–µ–Ω–¥—É—é –∑–∞–Ω—è—Ç—å —É–¥–æ–±–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏ –ø–æ—Å–ª—É—à–∞—Ç—å, —á—Ç–æ–±—ã –±—ã–ª–æ –ø–æ–ª–Ω–æ–µ –ø–æ–≥—Ä—É–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º. –ù–æ –µ—Å–ª–∏ –Ω–µ—É–¥–æ–±–Ω–æ —Å–ª—É—à–∞—Ç—å ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–æ—á–∫—É –ø–æ–¥ —ç—Ç–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º:",
        reply_markup=inline_markup
    )
    # –ó–∞–≤–µ—Ä—à–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–µ—Ä–µ—Ö–æ–¥–æ–º –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏ –∫–Ω–æ–ø–∫–æ–π "–ù–∞—á–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –∫–æ–º–ø–ª–µ–∫—Å–∞"
    markup = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    markup.add("üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "–ù–∞—á–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –∫–æ–º–ø–ª–µ–∫—Å–∞")
    await message.answer(
        "–ü–æ—Å–ª—É—à–∞—Ç—å –¥—Ä—É–≥–∏–µ —Å–∫–∞–∑–∫–∏ –º–æ–∂–Ω–æ –≤ —Ä–∞–∑–¥–µ–ª–µ 'üí§–û—Å–æ–±—ã–π —Ä–∞–∑–¥–µ–ª –¥–ª—è —Å–Ω–∞' —á–µ—Ä–µ–∑ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é üòâ\n\n"
        "–ê –ø–æ–∫–∞ –≤—Ç–æ—Ä–æ–π –¥–µ–Ω—å –∑–∞–≤–µ—Ä—à–µ–Ω! –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞–≤—Ç—Ä–∞ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º, —Ä–∞—Å—Å–∫–∞–∂—É –Ω–æ–≤—É—é —Å–∫–∞–∑–∫—É!\n\n"
        "–î–æ–±—Ä–æ–π –Ω–æ—á–∏ –∏ –ø—Ä–∏—è—Ç–Ω—ã—Ö —Å–Ω–æ–≤!\n-–ú–∞–Ω—è",
        reply_markup=markup
    )
    # –û–±–Ω–æ–≤–ª—è–µ–º —ç—Ç–∞–ø –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –∫—É—Ä—Å–∞
    update_course_stage(user_id, 9, completed=True, day=2)

# –≠—Ç–∞–ø 9: –ù–∞—á–∞–ª–æ —Ç—Ä–µ—Ç—å–µ–≥–æ –¥–Ω—è —á–µ—Ä–µ–∑ 12 —á–∞—Å–æ–≤
async def stage_9_day3_intro(message: types.Message):
    user_id = message.from_user.id
    if can_access_next_day(user_id, "day2"):
        await stage_10_breathing_technique(message)
    else:
        await message.answer("–î–µ–Ω—å 3 –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ 12 —á–∞—Å–æ–≤. –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –ø–æ–∑–∂–µ!")

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–¥—ä–µ–º–∞ –∏–∑ –±–∞–∑—ã
def get_wake_up_time(user_id):
    cursor.execute('SELECT wake_up_time FROM course_progress WHERE user_id = ?', (user_id,))
    result = cursor.fetchone()
    return result[0] if result else "–Ω–µ —É–∫–∞–∑–∞–Ω–æ"

# –≠—Ç–∞–ø 10: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ—Ç—å–µ–≥–æ –¥–Ω—è –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ —Å–Ω—É
async def stage_10_breathing_technique(message: types.Message):
    user_id = message.from_user.id
    wake_up_time = get_wake_up_time(user_id)

    # –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è —Å–Ω–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 8 —á–∞—Å–æ–≤)
    bed_time_hour = int(wake_up_time.split(":")[0]) - 8
    if bed_time_hour < 0:
        bed_time_hour += 24
    bed_time = f"{bed_time_hour}:00"

    await message.answer(
        f"üíÅ‚Äç‚ôÄÔ∏è –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º! –ù–∞–¥–µ—é—Å—å, –≤–∞—à —Å–æ–Ω —É–ª—É—á—à–∏–ª—Å—è. –ù–∞–ø–æ–º–Ω—é, —Ü–µ–ª—å –ø—Ä–æ—Å—ã–ø–∞—Ç—å—Å—è –≤ {wake_up_time} —É—Ç—Ä–∞, "
        f"–ø–æ—ç—Ç–æ–º—É –ø–æ—Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å —É—Å–Ω—É—Ç—å —Å–µ–≥–æ–¥–Ω—è –≤ {bed_time}, –∫–∞–∫ –∏ –≤—á–µ—Ä–∞.\n\n–õ–µ—á—å –≤ –∫—Ä–æ–≤–∞—Ç—å –ª—É—á—à–µ –∑–∞ 30-60 –º–∏–Ω—É—Ç –¥–æ —Å–Ω–∞."
    )
    markup = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    markup.add("–î–∞–≤–∞–π –ø—Ä–æ–¥–æ–ª–∂–∏–º")
    await message.answer("<b>–ù–∞ —Ç—Ä–µ—Ç–∏–π –¥–µ–Ω—å –º—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º:</b>\n"
                         "‚Ä¢ –†–∏—Ç—É–∞–ª—ã –¥–ª—è –∫—Ä–µ–ø–∫–æ–≥–æ —Å–Ω–∞\n"
                         "‚Ä¢ –ö–∞–∫ —Å–Ω–∏–∂–∞—Ç—å —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å?\n"
                         "‚Ä¢ –ü–æ—Å–ª—É—à–∞–µ–º —Å–∫–∞–∑–∫—É –¥–ª—è —Å–Ω–∞", parse_mode='HTML')
    await message.answer("–ö–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É '–î–∞–≤–∞–π –ø—Ä–æ–¥–æ–ª–∂–∏–º'", reply_markup=markup)
    update_course_stage(message.from_user.id, 11)


# –≠—Ç–∞–ø 11: –ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –¥–ª—è —Å–Ω–∞
async def stage_11_sleep_tips(message: types.Message):
    await message.answer(
        "–í–æ—Ç —Ç—Ä–µ—Ç—å—è –∑–∞–ø–∏—Å—å. –ö–∞–∫ –∏ –≤—Å–µ–≥–¥–∞, —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –ø–æ—Å–ª—É—à–∞—Ç—å –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–æ–≥—Ä—É–∂–µ–Ω–∏—è. –û–∑–≤—É—á–∏–≤–∞–µ—Ç –æ–¥–∏–Ω –∏–∑ –º–æ–∏—Ö —Å–æ–∑–¥–∞—Ç–µ–ª–µ–π ‚Äî –î–∂–æ—Ä–¥–∂."
    )
    # –£–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Ñ–∞–π–ª—É
    file_path = "sleep_complex/–¢—Ä–µ—Ç–∏–∏ÃÜ –¥–µ–Ω—å –∫–æ–º–ø–ª–µ–∫—Å–∞.mp3"
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª
    if os.path.exists(file_path):
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ—Ñ–∞–π–ª
        await message.answer_audio(audio=InputFile(file_path))
    else:
        await message.answer("–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
    # –û–±–Ω–æ–≤–ª—è–µ–º —ç—Ç–∞–ø –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    update_course_stage(message.from_user.id, 12, completed=True, day=3)
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é —Ç—Ä–µ—Ç—å–µ–≥–æ –¥–Ω—è
    await stage_12_day3_end(message)

# –≠—Ç–∞–ø 12: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç—Ä–µ—Ç—å–µ–≥–æ –¥–Ω—è –∏ –∫—É—Ä—Å–∞
async def stage_12_day3_end(message: types.Message):
    # –°–æ–∑–¥–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ —Ç–µ–∫—Å—Ç 3-–≥–æ –¥–Ω—è
    inline_markup = InlineKeyboardMarkup()
    inline_markup.add(
        InlineKeyboardButton(text="–ü—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç 3 –¥–Ω—è", url="https://www.netoropis.ru/posts/3DayMasha")
    )
    await message.answer(
        "–ï—Å–ª–∏ –Ω–µ—É–¥–æ–±–Ω–æ —Å–ª—É—à–∞—Ç—å ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç –ø–æ —Å—Å—ã–ª–∫–µ:",
        reply_markup=inline_markup
    )
    # –ó–∞–≤–µ—Ä—à–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await message.answer(
        "–ü–æ–∑–¥—Ä–∞–≤–ª—è—é, –≤—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏ 3-—Ö –¥–Ω–µ–≤–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å! üéâ\n\n"
        "–ù–∞–¥–µ—é—Å—å, —á—Ç–æ —ç—Ç–∏ —Å–æ–≤–µ—Ç—ã –ø–æ–º–æ–≥—É—Ç –≤–∞–º —É–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Å–ª–µ–¥–æ–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º –¥–ª—è –∑–¥–æ—Ä–æ–≤–æ–≥–æ —Å–Ω–∞ –∏ –ø—Ä–∞–∫—Ç–∏–∫–∞–º –¥—ã—Ö–∞–Ω–∏—è.\n\n"
        "–î–æ–±—Ä–æ–π –Ω–æ—á–∏ –∏ –ø—Ä–∏—è—Ç–Ω—ã—Ö —Å–Ω–æ–≤!\n-–ú–∞–Ω—è"
    )
    # –ö–Ω–æ–ø–∫–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
    markup = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    markup.add("üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "–ü—Ä–æ–π—Ç–∏ –∫–æ–º–ø–ª–µ–∫—Å –∑–∞–Ω–æ–≤–æ")
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=markup)
    # –û–±–Ω–æ–≤–ª—è–µ–º —ç—Ç–∞–ø –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –∫—É—Ä—Å–∞
    update_course_stage(message.from_user.id, 13, completed=True, day=3)

#–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã 1 –∏ 2 stage
@dp.message_handler(lambda message: message.text in [
    "–¢—Ä—É–¥–Ω–æ –∑–∞—Å–Ω—É—Ç—å –∏–∑-–∑–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –º—ã—Å–ª–µ–π",
    "–ß–∞—Å—Ç–æ –ø—Ä–æ—Å—ã–ø–∞—é—Å—å –Ω–æ—á—å—é –∏ –Ω–µ –º–æ–≥—É —Å–Ω–æ–≤–∞ —É—Å–Ω—É—Ç—å",
    "–ß—É–≤—Å—Ç–≤—É—é —Å–µ–±—è —É—Å—Ç–∞–≤—à–∏–º –¥–∞–∂–µ –ø–æ—Å–ª–µ –¥–æ–ª–≥–æ–≥–æ —Å–Ω–∞",
    "–ü—Ä–æ–±–ª–µ–º—ã —Å –∑–∞—Å—ã–ø–∞–Ω–∏–µ–º –∏–∑-–∑–∞ —à—É–º–∞ –∏–ª–∏ —Å–≤–µ—Ç–∞",
    "–î—Ä—É–≥–æ–µ (–ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ —Å–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç)"
])
async def handle_sleep_difficulty_response(message: types.Message):
    await message.answer(
        "–ü–æ–Ω—è–ª–∞ –≤–∞—Å. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–∏—è—Ç–Ω–æ. –î–∞–≤–∞–π—Ç–µ –ø–æ–ø—Ä–æ–±—É–µ–º –≤–º–µ—Å—Ç–µ –Ω–∞–π—Ç–∏ —Ä–µ—à–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —É–ª—É—á—à–∏—Ç—å —Å–æ–Ω."
    )
    update_course_stage(message.from_user.id, 2, sleep_difficulty=message.text)
    await stage_2_set_sleep_goal(message)

@dp.message_handler(lambda message: message.text in [
    "–ú–µ–ª–∞—Ç–æ–Ω–∏–Ω –∏–ª–∏ –¥—Ä—É–≥–∏–µ –¥–æ–±–∞–≤–∫–∏",
    "–ß—Ç–µ–Ω–∏–µ –∫–Ω–∏–≥ –∏–ª–∏ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –º—É–∑—ã–∫–∏ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º",
    "–î—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –∏–ª–∏ –º–µ–¥–∏—Ç–∞—Ü–∏–∏",
    "–ü–æ–ª–Ω–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã/—É–±–∏—Ä–∞–ª –≥–∞–¥–∂–µ—Ç—ã",
    "–ù–∏—á–µ–≥–æ –ø–æ–∫–∞ –Ω–µ –ø—Ä–æ–±–æ–≤–∞–ª",
    "–î—Ä—É–≥–æ–µ (–ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ —Å–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç)"
])
async def handle_sleep_improvement_response(message: types.Message):
    await message.answer(
        "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–¥–µ–ª–∏–ª–∏—Å—å. –í–∞—à –æ–ø—ã—Ç –æ—á–µ–Ω—å –≤–∞–∂–µ–Ω –¢–µ–ø–µ—Ä—å —è –ø–æ–¥–±–µ—Ä—É –ø–æ–¥—Ö–æ–¥—è—â–∏–π –¥–ª—è –≤–∞—Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–¥ —É–ª—É—á—à–µ–Ω–∏–µ–º —Å–Ω–∞."
    )
    update_course_stage(message.from_user.id, 3, sleep_improvement_attempts=message.text)
    await stage_3_relaxation(message)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–¥—ä–µ–º–∞ –¥–ª—è —ç—Ç–∞–ø–∞ 6
@dp.message_handler(lambda message: message.text in ["5:00", "6:00", "7:00", "8:00", "9:00", "10:00 –∏ –ø–æ–∑–∂–µ"])
async def handle_wake_up_time(message: types.Message):
    await stage_7_set_bedtime(message)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞—á–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –∫–æ–º–ø–ª–µ–∫—Å–∞"
@dp.message_handler(lambda message: message.text == "–ù–∞—á–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –∫–æ–º–ø–ª–µ–∫—Å–∞")
async def handle_start_next_day(message: types.Message):
    user_id = message.from_user.id
    stage = get_course_stage(user_id)
    # –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–Ω—é
    if stage == 5:  # –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è
        await stage_6_wake_up_time(message)  # –ü–µ—Ä–µ—Ö–æ–¥ –∫–æ –≤—Ç–æ—Ä–æ–º—É –¥–Ω—é
    elif stage == 9:  # –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Ç–æ—Ä–æ–≥–æ –¥–Ω—è
        await stage_10_breathing_technique(message)  # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ç—Ä–µ—Ç—å–µ–º—É –¥–Ω—é
    else:
        await message.answer("–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ —Å –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é.")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è "–î–∞–≤–∞–π –ø—Ä–æ–¥–æ–ª–∂–∏–º" —Å —É—á–µ—Ç–æ–º —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞
@dp.message_handler(lambda message: message.text == "–î–∞–≤–∞–π –ø—Ä–æ–¥–æ–ª–∂–∏–º")
async def handle_bed_confirmation(message: types.Message):
    user_id = message.from_user.id
    stage = get_course_stage(user_id)

    # –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞
    if stage == 8:  # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –¥–Ω—è
        await stage_8_day2_end(message)
    elif stage == 11:  # –≠—Ç–∞–ø —Ç—Ä–µ—Ç—å–µ–≥–æ –¥–Ω—è (–Ω–∞—á–∞–ª–æ —ç—Ç–∞–ø–∞ 11)
        await stage_11_sleep_tips(message)  # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —ç—Ç–∞–ø—É —Å —Å–æ–≤–µ—Ç–∞–º–∏ –¥–ª—è —Å–Ω–∞

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞—á–∞—Ç—å" –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ —Å —ç—Ç–∞–ø–∞ 0 –Ω–∞ —ç—Ç–∞–ø 1
@dp.message_handler(lambda message: message.text == "–ù–∞—á–∞—Ç—å")
async def start_course_step1(message: types.Message):
    user_id = message.from_user.id
    stage = get_course_stage(user_id)
    await start_sleep_course(message)

async def start_sleep_course(message: types.Message):
    user_id = message.from_user.id
    stage = get_course_stage(user_id)

    if stage == 0:
        await stage_0_welcome(message)
    elif stage == 1:
        await stage_1_sleep_duration(message)
    elif stage == 2:
        await stage_2_set_sleep_goal(message)
    elif stage == 3:
        await stage_3_relaxation(message)
    elif stage == 4:
        await stage_4_story(message)
    elif stage == 5:
        if can_access_next_day(user_id, "day1"):
            await stage_6_wake_up_time(message)
        else:
            await message.answer("–î–µ–Ω—å 2 –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ 12 —á–∞—Å–æ–≤. –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –ø–æ–∑–∂–µ!")
    elif stage == 7:
        await stage_7_set_bedtime(message)
    elif stage == 8:
        await stage_8_day2_end(message)
    elif stage == 9:
        if can_access_next_day(user_id, "day2"):
            await stage_10_breathing_technique(message)
        else:
            await message.answer("–î–µ–Ω—å 3 –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ 12 —á–∞—Å–æ–≤. –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –ø–æ–∑–∂–µ!")
    elif stage == 11:
        await stage_12_day3_end(message)
    elif stage >= 13:
        markup = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
        markup.add("üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "–ü—Ä–æ–π—Ç–∏ –∫–æ–º–ø–ª–µ–∫—Å –∑–∞–Ω–æ–≤–æ")
        await message.answer("–ö–æ–º–ø–ª–µ–∫—Å –∑–∞–≤–µ—Ä—à–µ–Ω! –ù–∞–∂–º–∏—Ç–µ '–ü—Ä–æ–π—Ç–∏ –∫–æ–º–ø–ª–µ–∫—Å –∑–∞–Ω–æ–≤–æ', –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–π—Ç–∏ –∫–æ–º–ø–ª–µ–∫—Å –∑–∞–Ω–æ–≤–æ.", reply_markup=markup)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
@dp.message_handler(lambda message: message.text == "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å")
async def handle_relaxation_confirmation(message: types.Message):
    user_id = message.from_user.id
    stage = get_course_stage(user_id)
    # –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞
    if stage == 3:  # –ü–µ—Ä–µ—Ö–æ–¥ —Å —ç—Ç–∞–ø–∞ 3 (–¢–µ—Ö–Ω–∏–∫–∞ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏—è) –Ω–∞ —ç—Ç–∞–ø 4 (–û—Ç–ø—Ä–∞–≤–∫–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞)
        await stage_4_story(message)
    elif stage == 8:  # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –¥–Ω—è
        await stage_8_day2_end(message)
    elif stage == 11:  # –≠—Ç–∞–ø —Ç—Ä–µ—Ç—å–µ–≥–æ –¥–Ω—è (–Ω–∞—á–∞–ª–æ —ç—Ç–∞–ø–∞ 11)
        await stage_11_sleep_tips(message)  # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —ç—Ç–∞–ø—É —Å —Å–æ–≤–µ—Ç–∞–º–∏ –¥–ª—è —Å–Ω–∞
    else:
        await message.answer("–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ —Å –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é.")

# –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫—É—Ä—Å–∞
def reset_course_progress(user_id):
    cursor.execute('''
        UPDATE course_progress 
        SET stage = 0, day1_completion_time = NULL, day2_completion_time = NULL, day3_completion_time = NULL
        WHERE user_id = ?
    ''', (user_id,))
    conn.commit()
    print(f"[DEBUG] –ü—Ä–æ–≥—Ä–µ—Å—Å –∫—É—Ä—Å–∞ —Å–±—Ä–æ—à–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–π—Ç–∏ –∫–æ–º–ø–ª–µ–∫—Å –∑–∞–Ω–æ–≤–æ"
@dp.message_handler(lambda message: message.text == "–ü—Ä–æ–π—Ç–∏ –∫–æ–º–ø–ª–µ–∫—Å –∑–∞–Ω–æ–≤–æ")
async def handle_restart_course(message: types.Message):
    user_id = message.from_user.id
    # –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    reset_course_progress(user_id)
    await message.answer("–ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–ø–ª–µ–∫—Å–∞ —Å–±—Ä–æ—à–µ–Ω–∞. –î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º –∑–∞–Ω–æ–≤–æ!")
    await stage_0_welcome(message)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É –≤—Ä–µ–º–µ–Ω–∏ —Å–Ω–∞
@dp.message_handler(lambda message: message.text in ["–î–æ 21:00", "–° 21:00 –¥–æ 23:00"])
async def handle_day2_bedtime_response(message: types.Message):
    user_id = message.from_user.id
    await message.answer("–û—Ç–ª–∏—á–Ω–æ! –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –æ—Ä–≥–∞–Ω–∏–∑–º –ø—Ä–∏–≤—ã–∫–Ω–µ—Ç –∫ –Ω–æ–≤–æ–º—É —Ä–µ–∂–∏–º—É.")
    await start_sleep_course(message)  # –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫—É—Ä—Å

@dp.message_handler(lambda message: message.text == "–Ø –≤ –∫—Ä–æ–≤–∞—Ç–∏")
async def handle_bedtime_confirmation(message: types.Message):
    user_id = message.from_user.id
    stage = get_course_stage(user_id)
    # –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —ç—Ç–∞–ø 3 –¥–Ω—è
    if stage == 9:
        await stage_10_breathing_technique(message)
    elif stage == 10:
        await stage_11_sleep_tips(message)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é" - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é
@dp.message_handler(lambda message: message.text == "üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
async def back_to_main_menu(message: types.Message):
    await send_permanent_menu(message)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–ª–∏ —Å–Ω–∞ –∏–∑ –±–∞–∑—ã
def get_sleep_goal(user_id):
    cursor.execute('SELECT sleep_goal FROM course_progress WHERE user_id = ?', (user_id,))
    result = cursor.fetchone()
    return result[0] if result else None

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ üìö–ü—Ä–æ–π—Ç–∏ sleep –∫–æ–º–ø–ª–µ–∫—Å
@dp.message_handler(lambda message: message.text == "üìö–ü—Ä–æ–π—Ç–∏ sleep –∫–æ–º–ø–ª–µ–∫—Å")
async def sleep_complex(message: types.Message):
    await start_sleep_course(message)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —Ç–µ—Å—Ç
@dp.message_handler(lambda message: message.text in ["–ú–µ–Ω–µ–µ 6 —á–∞—Å–æ–≤", "7 —á–∞—Å–æ–≤", "8 —á–∞—Å–æ–≤", "9 —á–∞—Å–æ–≤ –∏ –±–æ–ª—å—à–µ"])
async def handle_test_response(message: types.Message):
    user_id = message.from_user.id
    response = message.text
    await message.answer(f"–•–æ—Ä–æ—à–æ, —Ç–∞–∫ –∏ –∑–∞–ø–∏—à–µ–º ‚úçÔ∏è {response}")
    await start_sleep_course(message)  # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ü–µ–ª–∏ —Å–Ω–∞
@dp.message_handler(lambda message: message.text in ["7 —á–∞—Å–æ–≤", "8 —á–∞—Å–æ–≤", "9 —á–∞—Å–æ–≤"])
async def set_sleep_goal(message: types.Message):
    user_id = message.from_user.id
    sleep_goal = int(message.text.split()[0])
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–µ–ª–∏ —Å–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    cursor.execute('UPDATE course_progress SET sleep_goal = ?, stage = ? WHERE user_id = ?', (sleep_goal, 3, user_id))
    conn.commit()
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –ª–æ–≥–∏–∫–µ –∫—É—Ä—Å–∞
    await start_sleep_course(message)

#def get_random_mp3_file(folder, user_id):
#    try:
#        files = [f for f in os.listdir(folder) if f.endswith('.mp3')]
#        if not files:
#            print(f"[DEBUG] No .mp3 files found in folder {folder} for user {user_id}")
#            return None
#        file_path = os.path.join(folder, random.choice(files))
#        print(f"[DEBUG] Selected file {file_path} for user {user_id}")
#        return file_path
#    except Exception as e:
#        print(f"[ERROR] Error accessing folder {folder}: {e}")
#        return None
##############################################################################################################

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥–ø–∏—Å–∫–∏
@dp.message_handler(lambda message: message.text == "üåü–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø")
async def handle_subscription(message: types.Message):
    status, end_date = get_subscription_status(message.from_user.id)
    # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å—Ä–æ–∫–µ –¥–µ–π—Å—Ç–≤–∏—è
    if status:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
        markup.add("–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è", "–¢–µ—Ö. –ø–æ–¥–¥–µ—Ä–∂–∫–∞", "–î–Ω–µ–≤–Ω–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π", "üåü–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø",
                   "üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
        await message.answer(f"–í–∞—à –ø—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–µ–Ω –¥–æ {end_date}. –ü—Ä–∏—è—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!", reply_markup=markup)
        return
    # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –∏–∑ —Ç—Ä–µ—Ö —Ç–∏–ø–æ–≤
    await message.answer(
        "<b>üíé –¢–∞—Ä–∏—Ñ—ã –Ω–∞ –≤—ã–±–æ—Ä:</b>\n"
        "‚Ä¢ –ù–∞ 30 –¥–Ω–µ–π - 450 —Ä—É–±–ª–µ–π\n"
        "‚Ä¢ –ù–∞ 365 –¥–Ω–µ–π + 30 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ üéÅ - 3600 —Ä—É–±–ª–µ–π\n"
        "<u>–≠–∫–æ–Ω–æ–º–∏—è 39%! –≠—Ç–æ –≤—Å–µ–≥–æ 276 —Ä—É–±–ª–µ–π –≤ –º–µ—Å—è—Ü!</u> "
        "–î–µ—à–µ–≤–ª–µ –∫–∞–ø—É—á–∏–Ω–∫–∏", parse_mode='HTML')
        # –ö–Ω–æ–ø–∫–∏ —Å –≤—ã–±–æ—Ä–æ–º —Ç–∏–ø–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ 2 —Å—Ç—Ä–æ–∫–∏ –∏ 2 —Å—Ç–æ–ª–±—Ü–∞
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    markup.row("–û—Ñ–æ—Ä–º–∏—Ç—å –¥–æ—Å—Ç—É–ø –Ω–∞ 30 –¥–Ω–µ–π")
    markup.row("–û—Ñ–æ—Ä–º–∏—Ç—å –¥–æ—Å—Ç—É–ø –Ω–∞ 365+30 –¥–Ω–µ–π")
    markup.add("üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")  # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    # –ò–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∞ –ø–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º
    inline_markup = types.InlineKeyboardMarkup()
    inline_markup.add(
        types.InlineKeyboardButton(text="–ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø—Ä–æ –ø—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø", url="https://www.netoropis.ru/")
    )
    await message.answer(
        "<b>–°–ø–æ–∫–æ–π–Ω—ã–π —Å–æ–Ω ‚Äî –±–µ–∑ —É—Å–∏–ª–∏–π</b>\n"
        "–ü—Ä–µ–º–∏—É–º-–¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É –ú–∞–Ω–µ ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–∫–∞–∑–∫–∏, –∞ –≤–∞—à –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ª—ë–≥–∫–æ–≥–æ –∑–∞—Å—ã–ø–∞–Ω–∏—è, –≥–ª—É–±–æ–∫–æ–≥–æ —Å–Ω–∞ –∏ —Å–ø–æ–∫–æ–π–Ω–æ–≥–æ —É—Ç—Ä–∞\n\n"
        "üéØ <b>–ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ?</b>\n"
        "‚Ä¢ –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ—Å—å –∫ –ª—É—á—à–µ–º—É –æ—Ç–¥—ã—Ö—É –±–ª–∞–≥–æ–¥–∞—Ä—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏—Å—Ç–æ—Ä–∏—è–º —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º –º–µ–¥–∏—Ç–∞—Ü–∏–∏, –æ–∑–≤—É—á–µ–Ω–Ω—ã–º –∏–∑–≤–µ—Å—Ç–Ω—ã–º–∏ –≥–æ–ª–æ—Å–∞–º–∏\n"
        "‚Ä¢ –ü—Ä–æ—Å–ª–µ–¥–∏—Ç–µ –∑–∞ –≤–∞—à–∏–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º, –∫–∞–∂–¥—ã–π –≤–µ—á–µ—Ä, –ø–µ—Ä–µ–¥ —Å–Ω–æ–º\n"
        "‚Ä¢ –ê –µ—â–µ - —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –æ–∑–≤—É—á–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–π –ø–æ –∑–∞–ø—Ä–æ—Å—É, –ø—Ä–µ–≤—Ä–∞—â–∞—è –≤–∞—à–∏ –º–µ—á—Ç—ã –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å!",
        parse_mode='HTML', reply_markup=inline_markup)  # –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π –¥–ª—è –≤–∞—Å –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ–¥–ø–∏—Å–∫–∏:", reply_markup=markup)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ø–æ–¥–ø–∏—Å–∫–∏
@dp.message_handler(
    lambda message: message.text in ["–û—Ñ–æ—Ä–º–∏—Ç—å –¥–æ—Å—Ç—É–ø –Ω–∞ 30 –¥–Ω–µ–π", "–û—Ñ–æ—Ä–º–∏—Ç—å –¥–æ—Å—Ç—É–ø –Ω–∞ 365+30 –¥–Ω–µ–π"])
async def process_subscription_choice(message: types.Message):
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if message.text == "–û—Ñ–æ—Ä–º–∏—Ç—å –¥–æ—Å—Ç—É–ø –Ω–∞ 30 –¥–Ω–µ–π":
        value = "450.00"
        description = "–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø –Ω–∞ 30 –¥–Ω–µ–π"
        days = 30
    elif message.text == "–û—Ñ–æ—Ä–º–∏—Ç—å –¥–æ—Å—Ç—É–ø –Ω–∞ 365+30 –¥–Ω–µ–π":
        value = "3600.00"
        description = "–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø –Ω–∞ 365 –¥–Ω–µ–π + 30 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ"
        days = 365 + 30  # 1 –≥–æ–¥ + 2 –º–µ—Å—è—Ü–∞

    # –°–æ–∑–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂
    payment_data = create_payment(value, description)

    if payment_data:
        confirmation_url = payment_data['confirmation']['confirmation_url']
        payment_id = payment_data['id']

        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("–û–ø–ª–∞—Ç–∏—Ç—å", url=confirmation_url))

        # –ö–Ω–æ–ø–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ 2 —Å—Ç–æ–ª–±—Ü–∞ –∏ 2 —Å—Ç—Ä–æ–∫–∏, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø–∞–¥–∞–ª–∏
        subscription_markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
        subscription_markup.row("–û—Ñ–æ—Ä–º–∏—Ç—å –¥–æ—Å—Ç—É–ø –Ω–∞ 30 –¥–Ω–µ–π")
        subscription_markup.row("–û—Ñ–æ—Ä–º–∏—Ç—å –¥–æ—Å—Ç—É–ø –Ω–∞ 365+30 –¥–Ω–µ–π", "üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ –æ–ø–ª–∞—Ç—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        await message.answer(f"–ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã: {confirmation_url}", reply_markup=markup)
        await message.answer("–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã, –¥–æ—Å—Ç—É–ø –∫ —É–Ω–∏–∫–∞–ª—å–Ω–æ–º—É –∫–æ–Ω—Ç–µ–Ω—Ç—É –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã—Ç", reply_markup=subscription_markup)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
        payment_successful = await check_payment(payment_id)
        if payment_successful:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
            update_subscription_status(message.from_user.id, True, days)
            await message.answer(f"–î–æ—Å—Ç—É–ø –æ—Ñ–æ—Ä–º–ª–µ–Ω –Ω–∞ {days} –¥–Ω–µ–π. –ü—Ä–∏—è—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!\n\n–î–µ–Ω—å–≥–∏ –Ω–µ —Å–ø–∏—à—É—Ç—Å—è –≤ –∫—Ä–∞–π–Ω–∏–π –¥–µ–Ω—å, –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ")
            # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
            await send_permanent_menu(message)
        else:
            await message.answer("–ü–æ—Ö–æ–∂–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É –ø–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–º —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å—Å—ã–ª–∫–∞–º. –ï—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ —É–∂–µ –ø—Ä–æ—à–ª–∞, –Ω–µ –±–µ—Å–ø–æ–∫–æ–π—Ç–µ—Å—å. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª '–ü—Ä–æ—Ñ–∏–ª—å->–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø'")
    else:
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –ø–æ–∑–∂–µ.")

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø–æ–¥–ø–∏—Å–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞
async def show_subscription_options(message: types.Message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    markup.row("–û—Ñ–æ—Ä–º–∏—Ç—å –¥–æ—Å—Ç—É–ø –Ω–∞ 30 –¥–Ω–µ–π")
    markup.row("–û—Ñ–æ—Ä–º–∏—Ç—å –¥–æ—Å—Ç—É–ø –Ω–∞ 365+30 –¥–Ω–µ–π")
    markup.add("üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")

    await message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞ –∫—É–ø–∏—Ç—å?\n\n"
        "–ï—Å—Ç—å 3 —É—Ä–æ–≤–Ω—è –ø—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø–∞:\n"
        "- 30 –¥–Ω–µ–π ‚Äî 450 —Ä—É–±–ª–µ–π\n"
        "- 365 –¥–Ω–µ–π + 30 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ ‚Äî 3600 —Ä—É–±–ª–µ–π",
        reply_markup=markup
    )

#–ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞, –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –¥–∞—Ç—É –µ—ë –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.
#–ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ—Ç, –±–æ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ –∏–∑ –º–µ–Ω—é.
@dp.message_handler(commands=['üåü–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø'])
async def show_subscription_status(message: types.Message):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–Ω–∞ –ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    subscription = get_subscription_status(message.from_user.id)  # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–¥–ø–∏—Å–∫–µ
    if subscription and subscription['active']:
        remaining_days = (subscription['end_date'] - datetime.now()).days
        end_date = subscription['end_date'].strftime('%d.%m.%Y')
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–µ–∫—É—â–µ–π –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ
        await message.answer(f"–í–∞—à –ø—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω. –î–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –æ—Å—Ç–∞–ª–æ—Å—å {remaining_days} –¥–Ω–µ–π.\n"
                             f"–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞: {end_date}")
    else:
        # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ—Ç, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∫—É–ø–∏—Ç—å
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å –ø—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø–∞", reply_markup=subscription_menu())

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"
@dp.message_handler(lambda message: message.text == "–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è")
async def terms_of_use(message: types.Message):
    terms_text = (
        "–ü—É–±–ª–∏—á–Ω–∞—è –æ—Ñ–µ—Ä—Ç–∞\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ\n–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏\n\n–î–æ—Å—Ç—É–ø–Ω—ã –ø–æ —Å—Å—ã–ª–∫–µ: https://www.netoropis.ru/legal"
    )
    # –ü–æ–¥–º–µ–Ω—é "–ü—Ä–æ—Ñ–∏–ª—å"
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    markup.add("–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è", "–¢–µ—Ö. –ø–æ–¥–¥–µ—Ä–∂–∫–∞", "–î–Ω–µ–≤–Ω–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π", "üåü–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø", "üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
    await message.answer(terms_text, reply_markup=markup)

#–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
@dp.message_handler(lambda message: message.text == "üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
async def back_to_menu(message: types.Message):
    await send_permanent_menu(message)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"
#@dp.message_handler(lambda message: message.text == "–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É")
#async def cancel_subscription(message: types.Message):
    #    user_id = message.from_user.id
    #    update_subscription_status(user_id, False)  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –≤ False (–æ—Ç–º–µ–Ω–µ–Ω–æ)
    # –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–º–µ–Ω–µ –ø–æ–¥–ø–∏—Å–∫–∏
    #    await message.answer("–ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ —É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –¥–µ–Ω—å–≥–∏ –Ω–µ —Å–ø–∏—à—É—Ç—Å—è –≤ –∫—Ä–∞–π–Ω–∏–π –¥–µ–Ω—å, –Ω–æ —è –ø—Ä–æ—Å–ª–µ–∂—É, —á—Ç–æ–±—ã –Ω–∏—á–µ–≥–æ —Ç–æ—á–Ω–æ –Ω–µ —Å–ø–∏—Å–∞–ª–æ—Å—å. –í—ã —Å–º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞. –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ø–æ–≤–æ–¥—É –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–µ–Ω–µ–∂–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤, –æ–ø–∏—à–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ —Å–∏—Ç—É–∞—Ü–∏—é –∏ –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –Ω–∞ –ø–æ—á—Ç—É netoropisinfo@inbox.ru")
    # –°–æ–∑–¥–∞–µ–º –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏
    #markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    #markup.add("–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è", "–¢–µ—Ö. –ø–æ–¥–¥–µ—Ä–∂–∫–∞", "–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", "–î–Ω–µ–≤–Ω–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π", "üåü–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø",
    #           "üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –º–µ–Ω—é
    #await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=markup)


@dp.message_handler(lambda message: message.text == "–î–∞")
async def cancel_subscription(message: types.Message):
    update_subscription_status(message.from_user.id, False)  # –û—Ç–º–µ–Ω—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
    await message.answer("–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø –æ—Ç–º–µ–Ω–µ–Ω. –ú—ã –≤—Å–µ–≥–¥–∞ –±—É–¥–µ–º —Ä–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å —Å–Ω–æ–≤–∞.")
    await profile(message)  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –ø–æ–¥–º–µ–Ω—é "–ü—Ä–æ—Ñ–∏–ª—å"


@dp.message_handler(lambda message: message.text == "–ù–µ—Ç, —Ö–æ—á—É –¥–∞–ª—å—à–µ —Ö–æ—Ä–æ—à–æ —Å–ø–∞—Ç—å")
async def keep_subscription(message: types.Message):
    await message.answer("–Ø –æ—á–µ–Ω—å —Ä–∞–¥–∞, —á—Ç–æ –≤—ã —Ä–µ—à–∏–ª–∏ –æ—Å—Ç–∞—Ç—å—Å—è!")
    await profile(message)  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –ø–æ–¥–º–µ–Ω—é "–ü—Ä–æ—Ñ–∏–ª—å"

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ—Ñ–∏–ª—è —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –∫–Ω–æ–ø–∫–∏ "–î–Ω–µ–≤–Ω–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π"
@dp.message_handler(lambda message: message.text == "üë§–ü—Ä–æ—Ñ–∏–ª—å")
async def profile(message: types.Message):
    # –ü–æ–¥–º–µ–Ω—é "–ü—Ä–æ—Ñ–∏–ª—å"
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    markup.add("–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è", "–¢–µ—Ö. –ø–æ–¥–¥–µ—Ä–∂–∫–∞", "–î–Ω–µ–≤–Ω–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π", "üåü–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø", "üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
    await message.answer("–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å. –ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?", reply_markup=markup)


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–¢–µ—Ö. –ø–æ–¥–¥–µ—Ä–∂–∫–∞"
@dp.message_handler(lambda message: message.text == "–¢–µ—Ö. –ø–æ–¥–¥–µ—Ä–∂–∫–∞")
async def feedback(message: types.Message):
    feedback_text = (
        "–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å —Å–≤–æ–π –æ—Ç–∑—ã–≤, —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è, "
        "–ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞ —ç—Ç—É –ø–æ—á—Ç—É. –Ø –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–≤–µ—á—É –æ—Ç–≤–µ—Ç–Ω—ã–º –ø–∏—Å—å–º–æ–º. "
        "netoropisinfo@inbox.ru"
    )
    # –°–æ–∑–¥–∞–µ–º –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    markup.add("–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è", "–¢–µ—Ö. –ø–æ–¥–¥–µ—Ä–∂–∫–∞", "–î–Ω–µ–≤–Ω–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π", "üåü–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø",
               "üè†–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –º–µ–Ω—é
    await message.answer(feedback_text, reply_markup=markup)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–î–Ω–µ–≤–Ω–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π"
@dp.message_handler(lambda message: message.text == "–î–Ω–µ–≤–Ω–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π")
async def mood_journal_menu(message: types.Message):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏
    print("–ö–Ω–æ–ø–∫–∞ '–î–Ω–µ–≤–Ω–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π' –Ω–∞–∂–∞—Ç–∞")  # –í—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    # –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    markup.add("7 –¥–Ω–µ–π", "14 –¥–Ω–µ–π", "‚è™–ú–µ–Ω—é –ø—Ä–æ—Ñ–∏–ª—è")
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π:", reply_markup=markup)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "‚è™–ú–µ–Ω—é –ø—Ä–æ—Ñ–∏–ª—è"
@dp.message_handler(lambda message: message.text == "‚è™–ú–µ–Ω—é –ø—Ä–æ—Ñ–∏–ª—è")
async def back_to_profile_menu(message: types.Message):
    await profile(message)  # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –º–µ–Ω—é –ø—Ä–æ—Ñ–∏–ª—è

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞ (7 –¥–Ω–µ–π –∏–ª–∏ 14 –¥–Ω–µ–π)
@dp.message_handler(lambda message: message.text in ["7 –¥–Ω–µ–π", "14 –¥–Ω–µ–π"])
async def mood_history(message: types.Message):
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
    days = 7 if message.text == "7 –¥–Ω–µ–π" else 14
    mood_history_text = get_mood_history(message.from_user.id, days)  # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π
  #  await message.answer(mood_history_text)  # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    # –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=False)
    markup.add("7 –¥–Ω–µ–π", "14 –¥–Ω–µ–π", "‚è™–ú–µ–Ω—é –ø—Ä–æ—Ñ–∏–ª—è")
    await message.answer(mood_history_text, reply_markup=markup)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π
def get_mood_history(user_id, days):
    cursor.execute('''
        SELECT date, mood FROM mood_log
        WHERE user_id = ? AND date >= DATE('now', ? || ' days')
        ORDER BY date DESC
    ''', (user_id, -days))

    records = cursor.fetchall()

    if not records:
        return "–ò—Å—Ç–æ—Ä–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –ø—É—Å—Ç–∞."

    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏—Å—Ç–æ—Ä–∏–µ–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π
    mood_history_text = "–ò—Å—Ç–æ—Ä–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥:\n\n"
    for record in records:
        date, mood = record
        mood_history_text += f"{date}: {mood}\n"
    return mood_history_text

@dp.message_handler(lambda message: message.text == "–ú–µ–Ω—é –ø—Ä–æ—Ñ–∏–ª—è")
async def return_to_profile_menu(message: types.Message):
    await profile(message)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
@dp.message_handler()
async def handle_user_message(message: types.Message):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ª—é–±—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º–∏–ª–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –ò–ò.
    """
    response = ("–û–π, —Å–µ–π—á–∞—Å —è –ø–æ–∫–∞ –Ω–µ —É–º–µ—é –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, "
                "–Ω–æ —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è —É–º–Ω—ã–π –ò–ò, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø–æ–º–æ–≥–∞—Ç—å! üß†‚ú® –û—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å —Å –Ω–∞–º–∏!")
    await message.answer(response)

# –°—Ç–∞—Ä—Ç –±–æ—Ç–∞
if __name__ == '__main__':
    executor.start_polling(dp, skip_updates=True)
